<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doctor {{doc.name}}'s Profile - syncHealth</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/media/images/favicon-32x32.png">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

 <nav class="bg-white sticky top-0 z-50 shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <a href="/" class="text-xl font-bold text-[#29622E] hover:text-[#35993E]">syncHealth</a>

        <!-- Desktop Navigation -->
        <div class="hidden md:flex space-x-6 items-center">
          <a href="/" class="text-[#29622E] hover:text-[#35993E]">Home</a>
          <a href="/allDepartments" class="text-[#29622E] hover:text-[#35993E]">Departments</a>
          <a href="/allDoctors" class="text-[#29622E] hover:text-[#35993E]"><strong>Doctors</strong></a>
          <a href="/healthPackages" class="text-[#29622E] hover:text-[#35993E]">Packages</a>
          <a href="/all-test-centres" class="text-[#29622E] hover:text-[#35993E]">Test Centres</a>
          <a href="/aboutUs" class="text-[#29622E] hover:text-[#35993E]">About</a>
        </div>

        <!-- Icons -->
        <div class="hidden md:flex space-x-4 items-center">
          <a href="/chats/" class="text-[#29622E] hover:text-[#35993E]">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h8M8 14h4m5 3l-3-3H6a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2z"/>
            </svg>
          </a>
          <a href="{{profile_redirect}}" class="text-[#29622E] hover:text-[#35993E]">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-4 0-8 2-8 4v2h16v-2c0-2-4-4-8-4z"/>
            </svg>
          </a>
        </div>

        <!-- Mobile Menu Button -->
         
        <div class="md:hidden">
          <button id="menu-toggle" class="text-[#29622E] hover:text-[#35993E]">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Mobile Navigation -->
      <div id="mobile-menu" class="hidden md:hidden space-y-2">
        <a href="/" class="block text-[#29622E] hover:text-[#35993E]">Home</a>
        <a href="/allDepartments" class="block text-[#29622E] hover:text-[#35993E]">Departments</a>
        <a href="/allDoctors" class="block text-[#29622E] hover:text-[#35993E]"><strong>Doctors</strong></a>
        <a href="/healthPackages" class="text-[#29622E] hover:text-[#35993E]">Packages</a><br>
        <a href="/all-test-centres" class="text-[#29622E] hover:text-[#35993E]">Test Centres</a>
        <a href="/aboutUs" class="block text-[#29622E] hover:text-[#35993E]">About</a>
        <a href="/chats" class="text-[#29622E] hover:text-[#35993E]">Chats</a>
        <a href="{{profile_redirect}}" class="block text-[#29622E] hover:text-[#35993E]">Profile</a>
      </div>
    </div>
  </nav>


  <section class="p-6">
    <header class="text-2xl text-[#29622E] font-bold text-center mb-8">
    {{hospital}} | Dr. {{doc.name}} Details
    </header>

    <div class="flex flex-wrap lg:flex-nowrap gap-6">

      <div class="flex flex-col items-center bg-white shadow-md p-6 rounded-lg w-full lg:w-1/3">

        <div class="w-36 h-36 rounded-full overflow-hidden mb-4">
          <img src="/media/{{profilePic}}" alt="Profile" class="w-full h-full object-cover">
        </div>
        <p class="text-sm text-[#29622E] mb-4">Doctor Rating: ⭐{{ doc.rating }} / 10 (out of {{doc.rating_counts}} ratings)</p>
        <p class="text-sm text-[#29622E] mb-4">NMC Registration No: {{ doc.nmc_registration }}</p>
        <button class="emergency_booking bg-[#29622E] text-white px-6 py-2 rounded-lg shadow hover:bg-[#35993E] transition">
          Book an Online Appointment
        </button>


        <div class="mt-6">
          <p class="text-center mb-4 font-bold text-lg text-gray-700">Give Rating ⭐: <span id="rating-stars" class="inline-block">
            {% for i in "x"|ljust:10 %}
                <span class="star text-gray-300 text-2xl cursor-pointer" data-value="{{ forloop.counter }}">★</span>
            {% endfor %}
        </span></p>

        </div>


        <div id="rating-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg shadow-lg p-6 w-11/12 max-w-md">
            <h2 class="text-lg font-bold text-[#29622E] mb-4">Rate the Doctor</h2>
            <div class="flex items-center justify-between">
              <label for="rating-input" class="mr-4">Enter Rating (0-10):</label>
              <input id="rating-input" type="number" min="0" max="10" step="1" class="border border-gray-300 rounded-lg px-4 py-2 w-24">
            </div>
            <div class="flex justify-end mt-6 space-x-4">
              <button id="submit-rating" class="bg-[#29622E] text-white px-6 py-2 rounded-lg shadow hover:bg-[#35993E] transition">
                Submit
              </button>
              <button id="close-modal" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg shadow hover:bg-gray-400 transition">
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>


      <div class="bg-white shadow-md p-6 rounded-lg w-full lg:w-2/3">
        <p class="mb-4"><span class="font-bold">Name:</span> {{doc.name}}</p>
        <p class="mb-4"><span class="font-bold">Email:</span> <a href="mailto:{{doc.email}}">{{doc.email}}</a></p>
        <p class="mb-4"><span class="font-bold">Department:</span> {{doc.department}}</p>
        <p class="mb-4"><span class="font-bold">Expertise:</span> {{doc.expertise}}</p>
        <p class="mb-4"><span class="font-bold">Education:</span> {{doc.education}}</p>
        <p class="mb-4"><span class="font-bold">Hospitals Worked:</span> {{doc.hospitals_worked }}</p>
        <p class="mb-4"><span class="font-bold">Achievements:</span> {{doc.achievements}}</p>
        {% for doctor in patients.assigned_doctors_data %}
          <span> {{doctor.email}}</span>{% if not forloop.last %}, {% endif %}
      {% endfor %} 
        <p class="font-bold mb-2">Working Time:</p>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm border border-gray-300">
            <thead class="bg-gray-100">
              <tr class="text-[#29622E]">
                <th class="border px-4 py-2 text-left">Date</th>
                <th class="border px-4 py-2 text-left">Doctor Available Time</th>
              </tr>
            </thead>
            <tbody id="appointments-table"></tbody>

            
          </table>
        </div>

    
        <button id="appointment-btn" class="mt-4 bg-gray-300 text-white px-6 py-2 rounded-lg shadow cursor-not-allowed transition" disabled>
          Book Appointment on this day
        </button>
      </div>
    </div>
  </section>

<!-- Online Appointment Modal -->
<div id="emergency-modal" class="fixed inset-0 hidden z-50 bg-black bg-opacity-50 flex justify-center items-center">
  <div class="bg-white w-full max-w-2xl p-6 rounded-lg shadow-lg relative">
    <button onclick="document.getElementById('emergency-modal').classList.add('hidden')" class="absolute top-2 right-3 text-2xl">❌</button>
    <h2 class="text-xl font-bold text-[#29622E] mb-4">Book Online Emergency Appointment</h2>
    <p class="text-sm sm:text-base bg-gray-50 border border-gray-200 rounded-md p-3 inline-block">
      <span class="font-semibold text-green-700">Doctor:</span> 
      <span class="text-gray-800 ml-1">{{ doc.name }}</span> 
      <span class="text-gray-400 mx-2">/</span>
      <span class="font-semibold text-green-700">Department:</span> 
      <span class="text-gray-800 ml-1">{{ doc.department }}</span>
    </p>
    <table class="min-w-full text-sm border border-gray-300">
      <thead class="bg-gray-100 text-[#29622E]">
        <tr>
          <th class="border px-4 py-2 text-left">Date</th>
          <th class="border px-4 py-2 text-left">Available Time</th>
        </tr>
      </thead>
      <tbody id="emergency-slots-table"></tbody>
    </table>
    <button id="emergency-book-btn" class="mt-4 bg-gray-300 text-white px-6 py-2 rounded-lg shadow cursor-not-allowed transition" disabled>
      Book Emergency Appointment
    </button>
  </div>
</div>


  <footer class="bg-[#29622E] mt-20 text-white py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-3 gap-8">
      <!-- Logo Section -->
      <div class="flex items-center">
        <a href="/" class="text-3xl font-bold text-white hover:text-[#35993E]">syncHealth</a>
      </div>
  
      <!-- Contact Section -->
      <div class="space-y-3">
        <h3 class="text-lg font-bold">Contact</h3>
        <p>Email: customer@synchealth.com</p>
        <p>Phone: +977 1234567890</p>
        <a 
          href="#" 
          id="location-link" 
          class="text-white hover:underline"
        >
          Our Location: Kathmandu, Nepal
        </a>
      </div>
  
      <!-- Back to Top and Pharmacy Tracker -->
      <div class="text-right space-y-3">
        <button 
          id="back-to-top" 
          class="flex items-center justify-center bg-[#35993E] text-white p-2 rounded hover:bg-white hover:text-[#29622E]">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
          </svg>
          <span class="ml-2">Back to Top</span>
        </button>
        <a 
          href="#" 
          id="track-pharmacy" 
          class="flex block text-white hover:underline"
        >
          Track Nearby Pharmacies
        </a>
      </div>
    </div>
  
    <!-- Bottom Section -->
    <div class="border-t border-white mt-8 pt-4 text-center">
      <p>&copy; <span id="current-year"></span> syncHealth. All rights reserved.</p>
    </div>
  
    <!-- Popup Box -->
    <div id="popup-box" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center">
      <div class="bg-white p-6 rounded-lg max-w-md w-full">
        <h3 id="popup-title" class="text-lg text-[#35993E] font-bold mb-4"></h3> <!-- Dynamic Title Here -->
        <iframe 
          id="map" 
          src="" 
          width="100%" 
          height="200" 
          frameborder="0" 
          style="border:0;" 
          allowfullscreen="" 
          aria-hidden="false" 
          tabindex="0"
        ></iframe>
        <button 
          id="close-popup" 
          class="mt-4 w-full bg-[#808080] text-white py-2 px-4 rounded hover:bg-[#808099]">
          Close
        </button>
      </div>
    </div>
  </footer>

  <script>

    document.addEventListener('DOMContentLoaded', () => {
      const stars = document.querySelectorAll('#rating-stars .star');
      let selectedRating = 0;
    
      // Function to highlight stars up to the selected or hovered value
      function highlightStars(value) {
        stars.forEach(star => {
          star.classList.toggle('text-yellow-400', star.dataset.value <= value);
          star.classList.toggle('text-gray-300', star.dataset.value > value);
        });
      }
    
      // Add event listeners to each star
      stars.forEach(star => {
        // Highlight stars on hover
        star.addEventListener('mouseover', () => {
          const value = parseInt(star.dataset.value);
          highlightStars(value);
        });
    
        // Reset to selected rating on mouseout
        star.addEventListener('mouseout', () => {
          highlightStars(selectedRating);
        });

        let logged_in = "{{logged_in}}";
    
        // Show alert with rating on click
        star.addEventListener('click', async () => {
          const value = parseInt(star.dataset.value);
          const confirmMessage = `Are you sure you want to rate this value to doctor?`;
          
          if (logged_in == "True"){
            if (confirm(confirmMessage)) {
              selectedRating = value;
              let reviewData = {
                patient_email: "{{patients.email}}",
                doctor_email: "{{doc.email}}",
                rating: selectedRating,
              };
              let doc_email = "{{doc.email}}";
              let response = await fetch(`/api/submit-review/${doc_email}/`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
                body: JSON.stringify(reviewData),
            });
    
            let result = await response.json();
            console.log(result.error);
    
            if (response.ok) {
              location.reload();
              alert(`You rated ${selectedRating} rating!`);
            }
              
            }
            highlightStars(selectedRating);
          }
          else{
            alert("{{msg}}");
          }
        });
        function getCSRFToken() {
          return document.cookie.split("; ").find(row => row.startsWith("csrftoken="))?.split("=")[1];
      }
      });
    });


document.addEventListener("DOMContentLoaded", function () {
  const doctorEmail = "{{doc.email}}"; 
  const appointmentButton = document.getElementById("appointment-btn");
  const tableBody = document.getElementById("appointments-table");
  let selectedDate = null;
  let selectedTime = null;

  async function fetchWeeklySlots() {
      let response = await fetch(`/api/get-weekly-slots/${doctorEmail}/`);
      let data = await response.json();
      data.sort((a, b) => new Date(a.date) - new Date(b.date));

      console.log(data);
      tableBody.innerHTML = ""; 

      data.forEach((day, index) => {
          let row = document.createElement("tr");
          row.innerHTML = 
          `
          <tr>
            <td class="border px-4 py-2 whitespace-nowrap">${day.date} - ${day.day}</td>
            <td class="border px-4 py-2">
              <div class="flex flex-wrap gap-2 max-w-full">
                ${day.available_time.map(time => `
                  <button 
                    class="time-btn px-6 py-2 bg-gray-200 text-gray-700 rounded-lg shadow hover:bg-gray-300 transition cursor-pointer whitespace-nowrap"
                    data-date="${day.date}" 
                    data-time="${time}">
                    ${time}
                  </button>
                `).join("")}
              </div>
            </td>
          </tr>

          `;
          
          /*`
              <td class="border px-4 py-2">${day.date} - ${day.day}</td>
              <td class="border px-4 py-2 space-x-2">
                  ${day.available_time.map(time => `<button class="time-btn px-6 py-2 bg-gray-200 text-gray-700 rounded-lg shadow hover:bg-gray-300 transition" data-date="${day.date}" data-time="${time}">${time}</button>`).join(" ")}
              </td>
          `;*/
          tableBody.appendChild(row);
      });

      document.querySelectorAll(".time-btn").forEach(button => {
          button.addEventListener("click", () => {
              document.querySelectorAll(".time-btn").forEach(btn => {
                  btn.classList.remove("bg-[#29622E]", "text-white");
                  btn.classList.add("bg-gray-200", "text-gray-700");
              });

              button.classList.remove("bg-gray-200", "text-gray-700");
              button.classList.add("bg-[#29622E]", "text-white");
              selectedDate = button.dataset.date;
              selectedTime = button.dataset.time;

              appointmentButton.disabled = false;
              appointmentButton.classList.remove("bg-gray-300", "cursor-not-allowed");
              appointmentButton.classList.add("bg-[#29622E]", "hover:bg-[#35993E]");
          });
      });
  }

  appointmentButton.addEventListener("click", async function () {
      if (!selectedDate || !selectedTime) return;
      const logged_in = "{{logged_in}}";
      if (logged_in == "True"){

        let response = await fetch("/api/book-appointment/", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
            body: JSON.stringify({ doctor_email: doctorEmail, appointment_date: selectedDate, appointment_time: selectedTime, is_emergency:false })
        });

        let result = await response.json();
        console.log(result);
        if (response.ok) alert(result.message);
        else alert("Error Booking, " + result.error);
      } else{
        alert("{{msg}}");
      }
  });

///// GET EMERGENCY BOOKINGS

const emergencyBtn = document.querySelector(".emergency_booking");
  const emergencyModal = document.getElementById("emergency-modal");
  const emergencyTable = document.getElementById("emergency-slots-table");
  const emergencyBookBtn = document.getElementById("emergency-book-btn");

  let selectedEmergencyDate = null;
  let selectedEmergencyTime = null;
  const docEmail = "{{doc.email}}";

  emergencyBtn.addEventListener("click", () => {
    toggleEmergencyModal();
    fetchEmergencySlots();
  });

  function toggleEmergencyModal() {
    emergencyModal.classList.toggle("hidden");
    emergencyTable.innerHTML = "";
    emergencyBookBtn.disabled = true;
    emergencyBookBtn.classList.add("bg-gray-300", "cursor-not-allowed");
    emergencyBookBtn.classList.remove("bg-[#29622E]", "hover:bg-[#35993E]");
  }

  async function fetchEmergencySlots() {
    let res = await fetch(`/api/get-weekly-slots/${docEmail}/`);
    let data = await res.json();
    //console.log("Emergency data:", data);
    emergencyTable.innerHTML = "";

    data.sort((a, b) => new Date(a.date) - new Date(b.date));

    console.log(data);
    //emergencyTable.innerHTML = "";
    
    data.forEach(day => {
      if (day.emergency_available==true && day.available_emergency.length > 0) {
        let row = 
        `
        <tr>
          <td class="border px-4 py-2">${day.date} - ${day.day}</td>
          <td class="border px-4 py-2">
            <div class="flex flex-wrap gap-2 max-w-full">
              ${day.available_emergency.map(t => `
                <span class="inline-block">
                  <button 
                    class="emg-btn px-4 py-1 bg-gray-200 text-gray-700 rounded shadow hover:bg-gray-300 transition cursor-pointer whitespace-nowrap"
                    data-date="${day.date}" 
                    data-time="${t}">
                    ${t}
                  </button>
                </span>
              `).join("")}
            </div>
          </td>
        </tr>
        `
        
        
        /*
        `<tr>
          <td class="border px-4 py-2">${day.date} - ${day.day}</td>
          <td class="border px-4 py-2 space-x-2">
            ${day.available_emergency.map(t => `
              <button class="emg-btn px-4 py-1 bg-gray-200 text-gray-700 rounded shadow hover:bg-gray-300 transition" data-date="${day.date}" data-time="${t}">${t}</button>
            `).join("")}
          </td>
        </tr>`;
        */
        emergencyTable.innerHTML += row;
      }
    });

    document.querySelectorAll(".emg-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".emg-btn").forEach(b => {
          b.classList.remove("bg-[#29622E]", "text-white");
          b.classList.add("bg-gray-200", "text-gray-700");
        });
        btn.classList.remove("bg-gray-200", "text-gray-700");
        btn.classList.add("bg-[#29622E]", "text-white");

        selectedEmergencyDate = btn.dataset.date;
        selectedEmergencyTime = btn.dataset.time;

        emergencyBookBtn.disabled = false;
        emergencyBookBtn.classList.remove("bg-gray-300", "cursor-not-allowed");
        emergencyBookBtn.classList.add("bg-[#29622E]", "hover:bg-[#35993E]");
      });
    });
  }



const assignedDoctorEmails = [
{% for doctor in patients.assigned_doctors_data %}
  "{{ doctor.email }}"{% if not forloop.last %}, {% endif %}
{% endfor %}
];
const currentDoctorEmail = "{{ doc.email }}";

emergencyBookBtn.addEventListener("click", async () => {
if (!selectedEmergencyDate || !selectedEmergencyTime) return;

if (!assignedDoctorEmails.includes(currentDoctorEmail)) {
  alert("❌ You are not assigned to this doctor. Emergency booking denied.");
  return;
}

if (confirm(`Confirm booking for ${selectedEmergencyDate} at ${selectedEmergencyTime}?`)) {
  const logged_in = "{{logged_in}}";
  if (logged_in == "True") {
    let response = await fetch("/api/book-appointment/", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
      body: JSON.stringify({
        doctor_email: currentDoctorEmail,
        appointment_date: selectedEmergencyDate,
        appointment_time: selectedEmergencyTime,
        is_emergency: true
      })
    });

    let result = await response.json();
    if (response.ok) {
      alert("✅ Emergency appointment booked successfully!");
      toggleEmergencyModal();
    } else {
      alert("Booking failed: " + result.error);
    }
  } else {
    alert("{{msg}}");
  }
}
});





  function getCSRFToken() {
      return document.cookie.split("; ").find(row => row.startsWith("csrftoken="))?.split("=")[1];
  }

  fetchWeeklySlots();
});

// nav and footer js
const menuToggle = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');

    menuToggle.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
    });

    document.getElementById('back-to-top').addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    // Show Popup with Map for Location and Pharmacy Tracker
    const popupBox = document.getElementById('popup-box');
    const mapFrame = document.getElementById('map');
    const closePopup = document.getElementById('close-popup');
    const popupTitle = document.getElementById('popup-title'); // Access the title element
    
    document.getElementById('location-link').addEventListener('click', (event) => {
        event.preventDefault();
        popupTitle.textContent = 'Our Location'; // Set the title for location
        mapFrame.src = 'https://www.google.com/maps/embed?pb=YOUR_EMBED_MAP_URL'; // Replace with your actual Google Maps embed link
        popupBox.classList.remove('hidden');
    });
    
    // Dynamic Nearby Pharmacy Tracker
    document.getElementById('track-pharmacy').addEventListener('click', (event) => {
      event.preventDefault();
      popupTitle.textContent = 'Nearby Pharmacy Tracker';

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;

          // Embed Google Maps pharmacy search near user's location
          const searchURL = `https://www.google.com/maps?q=pharmacy&ll=${lat},${lon}&z=15&output=embed`;
          mapFrame.src = searchURL;
          popupBox.classList.remove('hidden');
        }, () => {
          alert("Location permission denied or unavailable.");
        });
      } else {
        alert("Your browser does not support geolocation.");
      }
    });
    // Close Popup
    closePopup.addEventListener('click', () => {
        popupBox.classList.add('hidden');
        mapFrame.src = ''; // Clear the iframe src when popup closes
    });
    
    // Set Current Year
    document.getElementById('current-year').textContent = new Date().getFullYear();

  </script>
</body>
</html>
