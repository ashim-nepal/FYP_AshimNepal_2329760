<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doctor's Profile | {{doctor.name}}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Optional: Styling for the scrollbar in the working time section */
    ::-webkit-scrollbar {
      height: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #29622E;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-track {
      background-color: #f1f1f1;
    }
  </style>
</head>
<body class="bg-gray-50">

  <section>
    Nav here
    <button onclick="confirmLogout()" class="text-green-700 font-semibold hover:underline">Logout</button>
  </section>

  <section class="p-6">
    <header class="text-2xl text-[#29622E] font-bold text-center mb-8">
      {{ branch_name }} | Dr. {{ doctor.name }}
    </header>

    <div class="flex flex-wrap lg:flex-nowrap gap-6">

      <div class="flex flex-col items-center bg-white shadow-md p-6 rounded-lg w-full lg:w-1/3">

        <div class="w-36 h-36 bg-gray-200 rounded-full mb-4"></div>
        <p class="text-sm text-[#29622E] mb-4">NMC Registration No: {{ doctor.nmc_registration}}</p>



        <div class="mt-6">
          <p class="text-center mb-4 font-bold text-lg text-gray-700">My Rating‚≠ê: {{doctor.rating}} / 10</p>
        </div>


        <div id="rating-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white hidden rounded-lg shadow-lg p-6 w-11/12 max-w-md">
            <h2 class="text-lg font-bold text-[#29622E] mb-4"></h2>
            <div class="flex items-center justify-between">
            </div>
            <div class="flex justify-end mt-6 space-x-4">
            </div>
          </div>
        </div>
      </div>


      <div class="bg-white shadow-md p-6 rounded-lg w-full lg:w-2/3">
        <p class="mb-4"><span class="font-bold">Name:</span> Dr. {{doctor.name}}</p>
        <p class="mb-4"><span class="font-bold">Email:</span> {{doctor.email}}</p>
        <p class="mb-4"><span class="font-bold">Department:</span> {{doctor.department}}</p>
        <p class="mb-4"><span class="font-bold">Expertise:</span> {{doctor.expertise}}</p>
        <p class="mb-4"><span class="font-bold">Education:</span> {{doctor.education}}</p>
        <p class="mb-4"><span class="font-bold">Hospitals Worked:</span> {{doctor.hospitals_worked}}</p>
        <p class="mb-4"><span class="font-bold">Achievements:</span> {{doctor.achievements}}</p>
        <button onclick="document.getElementById('appointment-modal').classList.remove('hidden')" 
            class="bg-[#29622E] text-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-[#29450E] text-700">
            View Appointment Requests
        </button>
        <button onclick="document.getElementById('appointment-modal').classList.remove('hidden')" 
            class="bg-[#29622E] text-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-[#29450E] text-700">
            Upcoming Appointments
        </button>

  </section>


  <section id ="scheduling-section">

  <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-2xl font-bold mb-4 text-center">Set Your Availability</h2>
    
    <div id="schedule-container" class="space-y-4">


    </div>

    <button id="save-schedule"
        class="mt-6 w-150 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
        Save Availability
    </button>
</div>
</section>


  <section>
    Footer here
  </section>


  <!-- Appointment Modal -->
<div id="appointment-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center">
  <div class="bg-white w-500 p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-bold mb-4">Appointment Requests</h3>
      <table class="w-full bg-gray-100 border">
          <thead>
              <tr class="text-gray-700">
                  <th class="border px-4 py-2">Patient</th>
                  <th class="border px-4 py-2">Date</th>
                  <th class="border px-4 py-2">Time</th>
                  <th class="border px-4 py-2">Status</th>
                  <th class="border px-4 py-2">Actions</th>
              </tr>
          </thead>
          <tbody id="appointment-list"></tbody>
      </table>
      <button onclick="document.getElementById('appointment-modal').classList.add('hidden')" class="bg-gray-500 text-white px-3 py-1 rounded mt-4">Close</button>
  </div>
</div>

<!-- Rejection Modal -->
<div id="rejection-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center">
  <div class="bg-white w-96 p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-bold mb-4">Reject Appointment</h3>
      <textarea id="rejection-reason" class="w-full border p-2 rounded" placeholder="Enter reason for rejection"></textarea>
      <button id="reject-appointment" class="bg-red-600 text-white px-4 py-2 rounded mt-4">Reject</button>
      <button onclick="document.getElementById('rejection-modal').classList.add('hidden')" class="bg-gray-500 text-white px-3 py-1 rounded mt-4">Close</button>
  </div>
</div>




  <script>
    document.addEventListener("DOMContentLoaded", async function () {
    let scheduleContainer = document.getElementById("schedule-container");
    let saveButton = document.getElementById("save-schedule");
  
  
      async function fetchSchedule() {
        try{
          let response = await fetch("/api/get-doctor-schedule/{{ doctor.email}}/");
          console.log(response);


      let result = await response.json(); // Convert JSON only if valid response
      console.log(result);
  
          scheduleContainer.innerHTML = "";
  
          let days = result.schedule || [];
  
          for (let i = 0; i < 7; i++) {
              let day = days[i] || {
                  date: getFutureDate(i+2),
                  working_day_type: null,
                  is_locked: false
              };
  
              let isLocked = day.is_locked ? "disabled" : "";
              let selectedOption = day.working_day_type || "None"; // Handle new entries
              let emergencyChecked = day.emergency_available ? "checked" : "";
  
              let row = `
                  <div class="flex justify-between items-center mb-4 p-3 border border-gray-300 rounded">
                      <span class="font-semibold">${day.date}-${day.day}</span>
                      <select data-date="${day.date}" class="schedule-select w-48 p-2 border rounded" ${isLocked}>
                          <option value="None" ${selectedOption === "None" ? "selected" : ""}>Not Set</option>
                          <option value="Full" ${selectedOption === "Full" ? "selected" : ""}>Full Day</option>
                          <option value="Half_Morning" ${selectedOption === "Half_Morning" ? "selected" : ""}>Half Day - Morning</option>
                          <option value="Half_Evening" ${selectedOption === "Half_Evening" ? "selected" : ""}>Half Day - Evening</option>
                          <option value="Leave" ${selectedOption === "Leave" ? "selected" : ""}>Leave</option>
                      </select>
                      <label class="flex items-center space-x-2">
                        <input type="checkbox" data-date="${day.date}" class="emergency-checkbox" ${emergencyChecked} ${isLocked}>
                        <span>Emergency Available</span>
                    </label>
                  </div>`;
              scheduleContainer.innerHTML += row;
          }
      } catch(error){
        console.log(error);
      }
    
    }
  
      saveButton.addEventListener("click", async function () {
          let selects = document.querySelectorAll(".schedule-select");
          let checkboxes = document.querySelectorAll(".emergency-checkbox");
          let scheduleData = [];
  
          selects.forEach((select, index) => {
              let selectedValue = select.value !== "None" ? select.value : null;
              scheduleData.push({
                  date: select.getAttribute("data-date"),
                  working_day_type: selectedValue,
                  emergency_available: checkboxes[index].checked,
              });
          });
  
          let response = await fetch("/api/update-doctor-schedule/{{ doctor.email }}/", {
              method: "POST",
              headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
              body: JSON.stringify({ schedule: scheduleData })
          });

  
          let result = await response.json();
          document.getElementById("response-message").innerText = result.message || "Error updating schedule";
  
          fetchSchedule(); // Reload after saving
      });
  
      function getFutureDate(daysAhead) {
          let today = new Date();
          today.setDate(today.getDate() + daysAhead);
          return today.toISOString().split("T")[0];
      }
  
      function getCSRFToken() {
          return document.cookie.split("; ").find(row => row.startsWith("csrftoken="))?.split("=")[1];
      }
  
      fetchSchedule();
    });


    // Appointments booking viewing appointments, accepting and rejecting
    document.addEventListener("DOMContentLoaded", function () {
      const appointmentList = document.getElementById("appointment-list");
      const responseMessage = document.getElementById("response-message");
      const rejectionModal = document.getElementById("rejection-modal");
      const rejectionReasonInput = document.getElementById("rejection-reason");
      let selectedAppointmentId = null;
  
      async function fetchAppointments() {
          let response = await fetch("/api/get-doctor-appointments/");
          let result = await response.json();
          console.log(result);
  
          appointmentList.innerHTML = ""; // Clear existing data
  
          if (result.appointments.length === 0) {
              appointmentList.innerHTML = "<p class='text-gray-500 text-center'>No pending appointment requests.</p>";
              return;
          }
  
          result.appointments.forEach((appointment) => {
              let row = `
                  <tr class="border-b">
                      <td class="px-4 py-2">${appointment.patient_email}</td>
                      <td class="px-4 py-2">${appointment.appointment_date}</td>
                      <td class="px-4 py-2">${appointment.appointment_time}</td>
                      <td class="px-4 py-2">${appointment.is_emergency ? "üö® Emergency" : "Regular"}</td>
                      <td class="px-4 py-2">
                          <button onclick="approveAppointment('${appointment.id}')" class="bg-green-600 text-white px-3 py-1 rounded">Accept</button>
                          <button onclick="openRejectionModal('${appointment.id}')" class="bg-red-600 text-white px-3 py-1 rounded ml-2">Reject</button>
                      </td>
                  </tr>`;
              appointmentList.innerHTML += row;
          });
      }
  
      window.approveAppointment = async function (appointmentId) {
          let response = await fetch("/api/manage-appointment-request/", {
              method: "POST",
              headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
              body: JSON.stringify({ appointment_id: appointmentId, action: "Accept" }),
          });
  
          let result = await response.json();
          alert(result.message || "Could not Process Task");
          fetchAppointments();
      };
  
      window.openRejectionModal = function (appointmentId) {
          selectedAppointmentId = appointmentId;
          rejectionModal.classList.remove("hidden");
      };
  
      document.getElementById("reject-appointment").addEventListener("click", async function () {
          let rejectionReason = rejectionReasonInput.value.trim();
          if (!rejectionReason) {
              alert("Please provide a reason for rejection.");
              return;
          }
  
          let response = await fetch("/api/manage-appointment-request/", {
              method: "POST",
              headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
              body: JSON.stringify({ appointment_id: selectedAppointmentId, action: "Reject", rejection_reason: rejectionReason }),
          });
  
          let result = await response.json();
          rejectionModal.classList.add("hidden");
          print(result);
          alert(result.message || "Could not Process Task");
          fetchAppointments();
      });
  
      function getCSRFToken() {
          return document.cookie.split("; ").find((row) => row.startsWith("csrftoken="))?.split("=")[1];
      }
  
      fetchAppointments();
  });



      // Confirm Logout
  function confirmLogout() {
    if (confirm("Are you sure you want to logout?")) {
        window.location.href = "/logout/";
    }
}



  </script>
</body>
</html>
