<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doctor's Profile | {{doctor.name}} - syncHealth</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/media/images/favicon-32x32.png">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

  <nav class="bg-white sticky top-0 z-50 shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <a href="/" class="text-xl font-bold text-[#29622E] hover:text-[#35993E]">syncHealth</a>

        <!-- Desktop Navigation -->
        <div class="hidden md:flex space-x-6 items-center">
          <a href="/" class="text-[#29622E] hover:text-[#35993E]">Home</a>
          <a href="/allDepartments" class="text-[#29622E] hover:text-[#35993E]">Departments</a>
          <a href="/allDoctors" class="text-[#29622E] hover:text-[#35993E]">Doctors</a>
          <a href="/healthPackages" class="text-[#29622E] hover:text-[#35993E]">Packages</a>
          <a href="/all-test-centres" class="text-[#29622E] hover:text-[#35993E]">Test Centres</a>
          <a href="/aboutUs" class="text-[#29622E] hover:text-[#35993E]">About Us</a>
        </div>

        <!-- Icons -->
        <div class="hidden md:flex space-x-4 items-center">
          <a href="/chats/" class="text-[#29622E] hover:text-[#35993E]">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h8M8 14h4m5 3l-3-3H6a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2z"/>
            </svg>
          </a>
          <a href="{{profile_redirect}}" class="text-[#29622E] hover:text-[#35993E]">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-4 0-8 2-8 4v2h16v-2c0-2-4-4-8-4z"/>
            </svg>
          </a>
        </div>

        <!-- Mobile Menu Button -->
         
        <div class="md:hidden">
          <button id="menu-toggle" class="text-[#29622E] hover:text-[#35993E]">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Mobile Navigation -->
      <div id="mobile-menu" class="hidden md:hidden space-y-2">
        <a href="/" class="block text-[#29622E] hover:text-[#35993E]">Home</a>
        <a href="/allDepartments" class="block text-[#29622E] hover:text-[#35993E]">Departments</a>
        <a href="/allDoctors" class="block text-[#29622E] hover:text-[#35993E]">Doctors</a>
        <a href="/healthPackages" class="text-[#29622E] hover:text-[#35993E]">Packages</a>
        <a href="/all-test-centres" class="text-[#29622E] hover:text-[#35993E]">Test Centres</a>
        <a href="/aboutUs" class="block text-[#29622E] hover:text-[#35993E]">About Us</a>
        <a href="/chats" class="text-[#29622E] hover:text-[#35993E]">Chats</a>
        <a href="{{profile_redirect}}" class="block text-[#29622E] hover:text-[#35993E]">Profile</a>
      </div>
    </div>
  </nav>

  <section class="p-6">
    <header class="text-2xl text-[#29622E] font-bold text-center mb-8">
      {{ branch_name }} | Dr. {{ doctor.name }}
    </header>

    <div class="flex flex-wrap lg:flex-nowrap gap-6">

      <div class="flex flex-col items-center bg-white shadow-md p-6 rounded-lg w-full lg:w-1/3">

        <div class="w-36 h-36 bg-gray-200 rounded-full overflow-hidden mb-4">
          <img src="/media/{{profilePic}}" alt="Profile" class="w-full h-full object-cover">
        </div>
        <p class="text-sm text-[#29622E] mb-4">NMC Registration No: {{ doctor.nmc_registration}}</p>



        <div class="mt-6">
          <p class="text-center mb-4 font-bold text-lg text-gray-700">My Rating‚≠ê: {{doctor.rating}} / 10</p>
        
          
          <div class="flex flex-col gap-3 w-full">
            <a href="/change-password" class="flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 11c1.1 0 2-.9 2-2V7a2 2 0 00-4 0v2c0 1.1.9 2 2 2zm6 4v3a2 2 0 01-2 2H8a2 2 0 01-2-2v-3a6 6 0 1112 0z"/>
              </svg>
              Change Password
            </a>

            <button onclick="confirmLogout()" class="flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md transition">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h6a2 2 0 012 2v1"/>
              </svg>
              Logout
            </button>
          </div>
        
        </div>




        <div id="rating-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white hidden rounded-lg shadow-lg p-6 w-11/12 max-w-md">
            <h2 class="text-lg font-bold text-[#29622E] mb-4"></h2>
            <div class="flex items-center justify-between">
            </div>
            <div class="flex justify-end mt-6 space-x-4">
            </div>
          </div>
        </div>
      </div>


      <div class="bg-white shadow-md p-6 rounded-lg w-full lg:w-2/3">
        <p class="mb-4"><span class="font-bold">Name:</span> Dr. {{doctor.name}}</p>
        <p class="mb-4"><span class="font-bold">Email:</span> {{doctor.email}}</p>
        <p class="mb-4"><span class="font-bold">Department:</span> {{doctor.department}}</p>
        <p class="mb-4"><span class="font-bold">Expertise:</span> {{doctor.expertise}}</p>
        <p class="mb-4"><span class="font-bold">Education:</span> {{doctor.education}}</p>
        <p class="mb-4"><span class="font-bold">Hospitals Worked:</span> {{doctor.hospitals_worked}}</p>
        <p class="mb-4"><span class="font-bold">Achievements:</span> {{doctor.achievements}}</p>
        <button onclick="document.getElementById('appointment-modal').classList.remove('hidden')" 
            class="bg-[#29622E] text-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-[#29450E] text-700">
            View Appointment Requests
        </button>
        <button id="viewAppointments" 
            class="bg-[#29622E] text-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-[#29450E] text-700">
            View Upcoming Appointments
        </button>
        <button id="pastAppointments" 
            class="bg-[#29622E] text-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-[#29450E] text-700">
            View Past Appointments
        </button>

  </section>


  <section id ="scheduling-section">

  <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-2xl text-green-700 font-bold mb-4 text-center">Set Your Availability</h2>
    
    <div id="schedule-container" class="space-y-4">


    </div>

    <button id="save-schedule"
        class="mt-6 w-150 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
        Save Availability
    </button>
</div>
</section>


  <footer class="bg-[#29622E] mt-20 text-white py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-3 gap-8">
      <!-- Logo Section -->
      <div class="flex items-center">
        <a href="/" class="text-3xl font-bold text-white hover:text-[#35993E]">syncHealth</a>
      </div>
  
      <!-- Contact Section -->
      <div class="space-y-3">
        <h3 class="text-lg font-bold">Contact</h3>
        <p>Email: customer@synchealth.com</p>
        <p>Phone: +977 1234567890</p>
        <a 
          href="#" 
          id="location-link" 
          class="text-white hover:underline"
        >
          Our Location: Kathmandu, Nepal
        </a>
      </div>
  
      <!-- Back to Top and Pharmacy Tracker -->
      <div class="text-right space-y-3">
        <button 
          id="back-to-top" 
          class="flex items-center justify-center bg-[#35993E] text-white p-2 rounded hover:bg-white hover:text-[#29622E]">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
          </svg>
          <span class="ml-2">Back to Top</span>
        </button>
        <a 
          href="#" 
          id="track-pharmacy" 
          class="flex block text-white hover:underline"
        >
          Track Nearby Pharmacies
        </a>
      </div>
    </div>
  
    <!-- Bottom Section -->
    <div class="border-t border-white mt-8 pt-4 text-center">
      <p>&copy; <span id="current-year"></span> syncHealth. All rights reserved.</p>
    </div>
  
    <!-- Popup Box -->
    <div id="popup-box" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center">
      <div class="bg-white p-6 rounded-lg max-w-md w-full">
        <h3 id="popup-title" class="text-lg text-[#35993E] font-bold mb-4"></h3> <!-- Dynamic Title Here -->
        <iframe 
          id="map" 
          src="" 
          width="100%" 
          height="200" 
          frameborder="0" 
          style="border:0;" 
          allowfullscreen="" 
          aria-hidden="false" 
          tabindex="0"
        ></iframe>
        <button 
          id="close-popup" 
          class="mt-4 w-full bg-[#808080] text-white py-2 px-4 rounded hover:bg-[#808099]">
          Close
        </button>
      </div>
    </div>
  </footer>


  <!-- Appointment Modal -->
<div id="appointment-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center">
  <div class="bg-white w-500 p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-bold mb-4">Appointment Requests</h3>
      <table class="w-full bg-gray-100 border">
          <thead>
              <tr class="text-gray-700">
                  <th class="border px-4 py-2">Patient</th>
                  <th class="border px-4 py-2">Date</th>
                  <th class="border px-4 py-2">Time</th>
                  <th class="border px-4 py-2">Status</th>
                  <th class="border px-4 py-2">Actions</th>
              </tr>
          </thead>
          <tbody id="appointment-list"></tbody>
      </table>
      <button onclick="document.getElementById('appointment-modal').classList.add('hidden')" class="bg-gray-500 text-white px-3 py-1 rounded mt-4">Close</button>
  </div>
</div>

<!-- Rejection Modal -->
<div id="rejection-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center">
  <div class="bg-white w-96 p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-bold mb-4">Reject Appointment</h3>
      <textarea id="rejection-reason" class="w-full border p-2 rounded" placeholder="Enter reason for rejection"></textarea>
      <button id="reject-appointment" class="bg-red-600 text-white px-4 py-2 rounded mt-4">Reject</button>
      <button onclick="document.getElementById('rejection-modal').classList.add('hidden')" class="bg-gray-500 text-white px-3 py-1 rounded mt-4">Close</button>
  </div>
</div>


<!-- View Upcoming Appointments Modal -->
<div id="appointmentDialogue" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center">
  <div class="bg-white w-180 p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-bold mb-4">My Upcoming Appointments</h3>
      <table class="w-full bg-gray-100 border">
        <thead>
            <tr class="text-gray-700">
                <th class="border px-4 py-2">Patient</th>
                <th class="border px-4 py-2">Date</th>
                <th class="border px-4 py-2">Time</th>
                <th class="border px-4 py-2">Meeting Type</th>
                <th class="border px-4 py-2">Prescription</th>
                <th class="border px-4 py-2">Actions</th>
            </tr>
        </thead>
        <tbody id="appointmentList"></tbody>
    </table>
    <button onclick="document.getElementById('appointmentDialogue').classList.add('hidden')" class="bg-gray-500 text-white px-3 py-1 rounded mt-4">Close</button>
  </div>
</div>

<!-- View Past Appointments Modal -->
<div id="pastappointmentDialogue" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center">
  <div class="bg-white w-180 p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-bold mb-4">Past Appointments</h3>

      <!-- Auto-Sorting Search Bar -->
    <div class="mb-4 flex">
      <label><b>Patient's Email: </b></label> <input type="email" id="searchEmail" placeholder="Search by Patient Email" class="w-1/3 p-2 border rounded-md mr-2">
      <label><b>Date: </b></label> <input type="date" id="searchDate" class="w-1/4 p-2 border rounded-md mr-2">
      <button id="clearFilters" class="bg-red-400 bg-500 text-white px-4 py-2 rounded">Clear</button>
  </div>

      <table class="w-full bg-gray-100 border">
        <thead>
            <tr class="text-gray-700">
                <th class="border px-4 py-2">Patient</th>
                <th class="border px-4 py-2">Date</th>
                <th class="border px-4 py-2">Time</th>
                <th class="border px-4 py-2">Prescription</th>
                <th class="border px-4 py-2">Status</th>
            </tr>
        </thead>
        <tbody id="pastappointmentList"></tbody>
    </table>
    <button onclick="document.getElementById('pastappointmentDialogue').classList.add('hidden')" class="bg-gray-500 text-white px-3 py-1 rounded mt-4">Close</button>
  </div>
</div>

<!-- Prescription Modal -->
<!-- Prescription Modal -->
<div id="prescriptionModal" class="fixed inset-0 flex items-center justify-center z-50 hidden bg-black bg-opacity-50">
  <div class="bg-white w-full max-w-2xl p-6 rounded-lg shadow-lg">
    
    <!-- Header -->
    <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Prescription Form</h2>
    
    <form id="prescriptionForm" class="space-y-4">
      <!-- Dynamic Info -->
      <div id="prescription-info" class="text-sm text-gray-600 mb-2"></div>

      <!-- Hidden Fields -->
      <input type="hidden" id="prescriptionId">
      <input type="hidden" id="appointmentId">

      <!-- Form Fields -->
      <div>
        <label for="bloodPressure-sys" class="block text-gray-700 font-medium mb-1">Blood Pressure (Systolic):</label>
        <div class="flex items-center space-x-2">
          <input type="number" id="bloodPressure-sys" step="0.1" class="flex-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
          <span class="text-sm text-gray-600">mm/Hg</span>
        </div>
      </div>

      <div>
        <label for="bloodPressure-dias" class="block text-gray-700 font-medium mb-1">Blood Pressure (Diastolic):</label>
        <div class="flex items-center space-x-2">
          <input type="number" id="bloodPressure-dias" step="0.1" class="flex-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
          <span class="text-sm text-gray-600">mm/Hg</span>
        </div>
      </div>

      <div>
        <label for="diabetes" class="block text-gray-700 font-medium mb-1">Diabetes Level:</label>
        <input type="number" id="diabetes" step="0.1" class="flex-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
        <span class="text-sm text-gray-600">mg/dL</span>
      </div>

      <div>
        <label for="medication" class="block text-gray-700 font-medium mb-1">Medication:</label>
        <textarea id="medication" rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required></textarea>
      </div>

      <div>
        <label for="notes" class="block text-gray-700 font-medium mb-1">Notes:</label>
        <textarea id="notes" rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required></textarea>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end pt-4">
        <button type="button" id="closeModal" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md mr-2 transition">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-green-700 hover:bg-green-800 text-white rounded-md transition">Save Prescription</button>
      </div>
    </form>
  </div>
</div>


<!--

<div id="prescriptionModal" class="fixed inset-0 flex items-center justify-center hidden bg-gray-900 bg-opacity-50">
  <div class="bg-white w-1000 p-6 rounded-lg">
      <h2 class="text-xl font-bold mb-4 text-center">Prescription</h2>

      <form id="prescriptionForm">
        <div id="prescription-info">
        </div>
          <input type="hidden" id="prescriptionId">
          <input type="hidden" id="appointmentId">
          
          <label class="block font-semibold">Blood Pressure(Systolic):</label>
          <input type="float" id="bloodPressure-sys" class="w-full p-2 border rounded-md mb-2 required"><span>mm/Hg</span>

          <label class="block font-semibold">Blood Pressure(Diastolic):</label>
          <input type="float" id="bloodPressure-dias" class="w-full p-2 border rounded-md mb-2 required"><span>mm/Hg</span>

          <label class="block font-semibold">Diabetes:</label>
          <input type="float" id="diabetes" class="w-full p-2 border rounded-md mb-2 required">

          <label class="block font-semibold">Medication:</label>
          <textarea id="medication" class="w-full p-2 border rounded-md mb-2 required"></textarea>

          <label class="block font-semibold">Notes:</label>
          <textarea id="notes" class="w-full p-2 border rounded-md mb-2 required"></textarea>

          <div class="flex justify-end mt-4">
              <button type="button" id="closeModal" class="px-4 py-2 bg-gray-500 text-white rounded-md mr-2">Cancel</button>
              <button type="submit" class="px-4 py-2 bg-[#29622E] text-white rounded-md">Save Prescription</button>
          </div>
      </form>
  </div>
</div>
-->





<!-- Emergency Meeting Link Modal -->
<div id="emergency-modal" class="fixed inset-0 hidden bg-black bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white p-6 rounded-lg max-w-md w-full">
    <h2 class="text-lg font-bold text-[#29622E] mb-4">Enter Online Meeting Link</h2>
    <input type="text" id="meeting-link-input" class="w-full border p-2 rounded mb-4" placeholder="https://meet.example.com/...">
    <div class="flex justify-end gap-3">
      <button onclick="closeEmergencyModal()" class="bg-gray-400 text-white px-4 py-2 rounded">Cancel</button>
      <button onclick="sendEmergencyLink()" class="bg-green-600 text-white px-4 py-2 rounded">Send</button>
      
    </div>
  </div>
</div>




  <script>
    document.addEventListener("DOMContentLoaded", async function () {
    let scheduleContainer = document.getElementById("schedule-container");
    let saveButton = document.getElementById("save-schedule");
  
  
      async function fetchSchedule() {
        try{
          let response = await fetch("/api/get-doctor-schedule/{{ doctor.email}}/");
          console.log(response);


      let result = await response.json(); // Convert JSON only if valid response
      console.log(result);
  
          scheduleContainer.innerHTML = "";
  
          let days = result.schedule || [];
  
          for (let i = 0; i < 7; i++) {
              let day = days[i] || {
                  date: getFutureDate(i+2),
                  working_day_type: null,
                  is_locked: false
              };
  
              let isLocked = day.is_locked ? "disabled" : "";
              let selectedOption = day.working_day_type || "None"; // Handle new entries
              let emergencyChecked = day.emergency_available ? "checked" : "";
  
              let row = `
                  <div class="flex justify-between items-center mb-4 p-3 border border-gray-300 rounded">
                      <span class="font-semibold">${day.date}-${day.day}</span>
                      <select data-date="${day.date}" class="schedule-select w-48 p-2 border rounded" ${isLocked}>
                          <option value="None" ${selectedOption === "None" ? "selected" : ""}>Not Set</option>
                          <option value="Full" ${selectedOption === "Full" ? "selected" : ""}>Full Day</option>
                          <option value="Half_Morning" ${selectedOption === "Half_Morning" ? "selected" : ""}>Half Day - Morning</option>
                          <option value="Half_Evening" ${selectedOption === "Half_Evening" ? "selected" : ""}>Half Day - Evening</option>
                          <option value="Leave" ${selectedOption === "Leave" ? "selected" : ""}>Leave</option>
                      </select>
                      <label class="flex items-center space-x-2">
                        <input type="checkbox" data-date="${day.date}" class="emergency-checkbox" ${emergencyChecked} ${isLocked}>
                        <span>Emergency Available</span>
                    </label>
                  </div>`;
              scheduleContainer.innerHTML += row;
          }
      } catch(error){
        console.log(error);
      }
    
    }
  
      saveButton.addEventListener("click", async function () {
          let selects = document.querySelectorAll(".schedule-select");
          let checkboxes = document.querySelectorAll(".emergency-checkbox");
          let scheduleData = [];
  
          selects.forEach((select, index) => {
              let selectedValue = select.value !== "None" ? select.value : null;
              scheduleData.push({
                  date: select.getAttribute("data-date"),
                  working_day_type: selectedValue,
                  emergency_available: checkboxes[index].checked,
              });
          });
  
          let response = await fetch("/api/update-doctor-schedule/{{ doctor.email }}/", {
              method: "POST",
              headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
              body: JSON.stringify({ schedule: scheduleData })
              
          });

  
          let result = await response.json();
          document.getElementById("response-message").innerText = result.message || "Error updating schedule";
          alert(result.message || result.error);
          fetchSchedule(); // Reload after saving
      });
  
      function getFutureDate(daysAhead) {
          let today = new Date();
          today.setDate(today.getDate() + daysAhead);
          return today.toISOString().split("T")[0];
      }
  
      function getCSRFToken() {
          return document.cookie.split("; ").find(row => row.startsWith("csrftoken="))?.split("=")[1];
      }
  
      fetchSchedule();
    });


    // Appointments booking viewing appointments, accepting and rejecting
    document.addEventListener("DOMContentLoaded", function () {
      const appointmentList = document.getElementById("appointment-list");
      const responseMessage = document.getElementById("response-message");
      const rejectionModal = document.getElementById("rejection-modal");
      const rejectionReasonInput = document.getElementById("rejection-reason");
      let selectedAppointmentId = null;
  
      async function fetchAppointments() {
          let response = await fetch("/api/get-doctor-appointments/");
          let result = await response.json();
          
          const filteredAppointments = result.appointments.filter(
            (appointments) => appointments.appointment_status === "Pending"
          );
          console.log(filteredAppointments);
  
          appointmentList.innerHTML = ""; // Clear existing data
  
          if (filteredAppointments.length === 0) {
              appointmentList.innerHTML = "<p class='text-gray-500 text-center'>No pending appointment requests.</p>";
              return;
          }
  
          filteredAppointments.forEach((appointment) => {

            


              let row = `
                  <tr class="border-b hover:bg-gray-50 transition">
                      <td class="px-4 py-3 text-blue-700 font-medium underline">
                        <a href="/viewPatientProfile/${appointment.patient_email}/" target="_blank">
                          ${appointment.patient_email}
                        </a>
                      </td>

                      <td class="px-4 py-3 text-gray-700 font-semibold text-sm whitespace-nowrap">
                        üìÖ ${appointment.appointment_date}
                      </td>

                      <td class="px-4 py-3 text-gray-700 font-semibold text-sm whitespace-nowrap">
                        ‚è∞ ${appointment.appointment_time}
                      </td>

                      <td class="px-4 py-3">
                        <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold 
                          ${appointment.is_emergency ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                          ${appointment.is_emergency ? " Emergency" : "Regular"}
                        </span>
                      </td>

                      <td class="px-4 py-3 space-x-2 whitespace-nowrap">
                        <button onclick="approveAppointment('${appointment.id}')" 
                          class="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1.5 rounded shadow-sm transition">
                          Accept
                        </button>
                        <button onclick="openRejectionModal('${appointment.id}')" 
                          class="bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1.5 rounded shadow-sm transition">
                          Reject
                        </button>
                      </td>
                    </tr>
                  `;
              appointmentList.innerHTML += row;
          });
      }
  
      window.approveAppointment = async function (appointmentId) {
          let response = await fetch("/api/manage-appointment-request/", {
              method: "POST",
              headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
              body: JSON.stringify({ appointment_id: appointmentId, action: "Accept" }),
          });
  
          let result = await response.json();
          alert(result.message || "Could not Process Task");
          fetchAppointments();
      };
  
      window.openRejectionModal = function (appointmentId) {
          selectedAppointmentId = appointmentId;
          rejectionModal.classList.remove("hidden");
      };
  
      document.getElementById("reject-appointment").addEventListener("click", async function () {
          let rejectionReason = rejectionReasonInput.value.trim();
          if (!rejectionReason) {
              alert("Please provide a reason for rejection.");
              return;
          }
  
          let response = await fetch("/api/manage-appointment-request/", {
              method: "POST",
              headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
              body: JSON.stringify({ appointment_id: selectedAppointmentId, action: "Reject", rejection_reason: rejectionReason }),
          });
  
          let result = await response.json();
          rejectionModal.classList.add("hidden");
          print(result);
          alert(result.message || "Could not Process Task");
          fetchAppointments();
      });
  
      function getCSRFToken() {
          return document.cookie.split("; ").find((row) => row.startsWith("csrftoken="))?.split("=")[1];
      }
  
      fetchAppointments();
  });



  // Upcoming Appointments
  document.getElementById("viewAppointments").addEventListener("click", function() {
    fetch('/api/get-doctor-appointments/')
        .then(response => response.json())
        .then(data => {
          const filteredAppointments = data.appointments.filter(
            (appointments) => appointments.appointment_status === "Approved" // && appointments.appointment_status != "Rejected"
          );

          document.getElementById("appointmentDialogue").classList.remove("hidden")

          console.log(filteredAppointments);
          if (filteredAppointments.length === 0) {
            appointmentList.innerHTML = "<p class='text-gray-500 text-center'>No any upcoming appointments.</p>";
            return;
        }
            let content = "";
            filteredAppointments.forEach(appointment => {
                let disabled = (appointment.appointment_status === "Completed" || appointment.appointment_status === "Cancelled") ? "disabled" : "";
                let completedColor = (disabled) ? "gray" : "green";
                let cancelledColor = (disabled) ? "gray" : "red";
                
                let emergencyCell = appointment.is_emergency
        ? `<td class="px-4 py-2">
             <button onclick="openLinkModal('${appointment.id}', '${appointment.patient_email}')" 
                     class="text-red-600 font-semibold underline"> Emergency</button>
           </td>`
        : `<td class="px-4 py-2">Regular</td>`;

                content += `
                <tr class="border-b hover:bg-gray-50 transition">

                  <td class="px-4 py-3 text-blue-700 underline font-medium">
                    <a href="/viewPatientProfile/${appointment.patient_email}/" target="_blank">
                      ${appointment.patient_email}
                    </a>
                  </td>

                  <td class="px-4 py-3 text-gray-700 font-semibold text-sm whitespace-nowrap">
                    üìÖ ${appointment.appointment_date}
                  </td>

                  <td class="px-4 py-3 text-gray-700 font-semibold text-sm whitespace-nowrap">
                    ‚è∞ ${appointment.appointment_time}
                  </td>

                  ${appointment.is_emergency ? `
                    <td class="px-4 py-3">
                      <button onclick="openLinkModal('${appointment.id}', '${appointment.patient_email}')" 
                              class="inline-block px-2 py-1 text-sm font-medium rounded-full bg-red-100 text-red-700">
                        <u>Emergency</u>
                      </button>
                    </td>` : `
                    <td class="px-4 py-3">
                      <span class="inline-block px-2 py-1 text-sm font-medium rounded-full bg-green-100 text-green-700">
                        Regular
                      </span>
                    </td>`}

                  
                  <td class="px-4 py-3 text-center">
                    <button onclick="openPrescription('${appointment.id}', '${appointment.appointment_date}')" 
                            class="text-xl hover:scale-110 transition-transform" 
                            title="View Prescription" style="background: none; border: none;">
                      üìÑüìÑüìÑüìÑ
                    </button>
                  </td>

                  <td class="px-4 py-3 space-x-2">
                    <button onclick="updateStatus('${appointment.id}', 'Completed')" 
                            class="bg-${completedColor}-600 hover:bg-${completedColor}-700 text-white text-sm px-3 py-1.5 rounded shadow-sm transition" ${disabled}>
                      Complete
                    </button>
                    <button onclick="updateStatus('${appointment.id}', 'Cancelled')" 
                            class="bg-${cancelledColor}-600 hover:bg-${cancelledColor}-700 text-white text-sm px-3 py-1.5 rounded shadow-sm transition" ${disabled}>
                      Cancel
                    </button>
                  </td>
                </tr>
                `;

                /*
                      <tr class="border-b">
                      <td class="px-4 py-2"><a href="/viewPatientProfile/${appointment.patient_email}/">${appointment.patient_email}</a></td>
                      <td class="px-4 py-2">${appointment.appointment_date}</td>
                      <td class="px-4 py-2">${appointment.appointment_time}</td>
                      ${emergencyCell}
                      <td class="px-4 py-2">
                        <button onclick="openPrescription('${appointment.id}', '${appointment.appointment_date}')" 
                          style="background: none; border: none;">
                          üìÑüìÑüìÑüìÑ
                        </button>
                      </td>
                      <td class="px-4 py-2">
                          <button onclick="updateStatus('${appointment.id}', 'Completed')" class="bg-${completedColor}-600 text-white px-3 py-1 rounded" ${disabled}>Complete</button>
                          <button onclick="updateStatus('${appointment.id}', 'Cancelled')" class="bg-${cancelledColor}-600 text-white px-3 py-1 rounded ml-2" ${disabled}>Cancel</button>
                      </td>
                  </tr>
                  */
                
            });
            document.getElementById("appointmentList").innerHTML = content;
        });
});

function updateStatus(appointment_id, status) {
    fetch('/api/update-appointment/', { 
        method: "POST", 
        body: JSON.stringify({ appointment_id, status }),
        headers: { "Content-Type": "application/json" }
    })
    .then(() => alert(`Appointment marked as ${status}!`))
    .then(() => location.reload());
}


// Past
document.getElementById("pastAppointments").addEventListener("click", function () {
  fetch('/api/get-doctor-appointments/')
      .then(response => response.json())
      .then(data => {
          let allAppointments = data.appointments.filter(
              appointment => appointment.appointment_status === "Completed" || appointment.appointment_status === "Cancelled"
          );

          document.getElementById("pastappointmentDialogue").classList.remove("hidden");

          if (allAppointments.length === 0) {
              document.getElementById("pastappointmentList").innerHTML = "<p class='text-gray-500 text-center'>No past appointments exist.</p>";
              return;
          }

          // Store data globally for filtering
          window.filteredAppointments = allAppointments;
          displayAppointments(allAppointments);
      });
});

// Filtering Function - Runs Automatically as User Inputs Data
document.getElementById("searchEmail").addEventListener("input", filterAppointments);
document.getElementById("searchDate").addEventListener("change", filterAppointments);
document.getElementById("clearFilters").addEventListener("click", clearFilters);

function filterAppointments() {
  let email = document.getElementById("searchEmail").value.trim().toLowerCase();
  let date = document.getElementById("searchDate").value;

  let filtered = window.filteredAppointments;

  if (email) {
      filtered = filtered.filter(appointment => 
          appointment.patient_email.toLowerCase().includes(email)
      );
  }
  if (date) {
      filtered = filtered.filter(appointment => appointment.appointment_date === date);
  }

  displayAppointments(filtered);
}

// Function to Display Appointments in the Table
function displayAppointments(appointments) {
  let content = "";

  if (appointments.length === 0) {
      content = "<p class='text-gray-500 text-center'>No matching appointments found.</p>";
  } else {
      appointments.forEach(appointment => {
          let text_color = (appointment.appointment_status === "Completed") ? "Completed" : "";
          let completedColor = (text_color) ? "green" : "red";

          content += `
          <tr class="border-b hover:bg-gray-50 transition" 
                  data-email="${appointment.patient_email.toLowerCase()}" 
                  data-date="${appointment.appointment_date}">

                <td class="px-4 py-3 text-blue-700 underline font-medium">
                  <a href="/viewPatientProfile/${appointment.patient_email}/" target="_blank">
                    ${appointment.patient_email}
                  </a>
                </td>

                <td class="px-4 py-3 text-gray-700 font-semibold whitespace-nowrap">
                  üìÖ ${appointment.appointment_date}
                </td>

                <td class="px-4 py-3 text-gray-700 font-semibold whitespace-nowrap">
                  ‚è∞ ${appointment.appointment_time}
                </td>

                <td class="px-4 py-3 text-center">
                  <button onclick="openPrescription('${appointment.id}', '${appointment.appointment_date}')" 
                          class="text-xl hover:scale-110 transition-transform" 
                          title="View Prescription" style="background: none; border: none;">
                    üìÑüìÑüìÑüìÑ
                  </button>
                </td>

                <td class="px-4 py-3">
                  <span class="inline-block px-2 py-1 text-sm font-medium rounded-full bg-${completedColor}-100 text-${completedColor}-700">
                    ${appointment.appointment_status}
                  </span>
                </td>
              </tr>

          `;


          /*
              <tr class="border-b">
                  <td class="px-4 py-2"><a href="/viewPatientProfile/${appointment.patient_email}/">${appointment.patient_email}</a></td>
                  <td class="px-4 py-2">${appointment.appointment_date}</td>
                  <td class="px-4 py-2">${appointment.appointment_time}</td>
                  <td class="px-4 py-2">
                      <button onclick="openPrescription('${appointment.id}', '${appointment.appointment_date}')" 
                          style="background: none; border: none;">
                          üìÑüìÑüìÑüìÑ
                      </button>
                  </td>
                  <td class="px-4 py-2"><span class="bg-white text-${completedColor}-180">${appointment.appointment_status}</span></td>
              </tr>
          `;*/
      });
  }

  document.getElementById("pastappointmentList").innerHTML = content;
}


// Clear Filters and Show All Records
function clearFilters() {
  document.getElementById("searchEmail").value = "";
  document.getElementById("searchDate").value = "";
  displayAppointments(window.filteredAppointments); // Show all records again
}


function openPrescription(appointmentId) {
  document.getElementById('appointmentId').value = appointmentId;
  
  // Fetch prescription details if exists
  fetch(`/get_prescription/${appointmentId}/`)
      .then(response => response.json())
      .then(data => {
        console.log(data);
          if (data.prescription) {
              document.getElementById('prescriptionId').value = data.prescription.id;
              document.getElementById('bloodPressure-sys').value = data.prescription.blood_pressure_sys || "";
              document.getElementById('bloodPressure-dias').value = data.prescription.blood_pressure_dias || "";
              document.getElementById('diabetes').value = data.prescription.diabetes || "";
              document.getElementById('medication').value = data.prescription.medication || "";
              document.getElementById('notes').value = data.prescription.notes || "";
          }
          document.getElementById('prescription-info').innerHTML = `

          <span>Patients details: </span>
          <h4>Name: ${data.prescription.patient_name}</h4>
          Date: ${data.prescription.date} | ${data.prescription.time}

          `;
      });

  document.getElementById('prescriptionModal').classList.remove('hidden');
  
}

document.getElementById('closeModal').addEventListener('click', () => {
  document.getElementById('prescriptionModal').classList.add('hidden');
  document.getElementById('prescriptionId').value = "";
  document.getElementById('bloodPressure-sys').value ="";
  document.getElementById('bloodPressure-dias').value ="";
  document.getElementById('diabetes').value ="";
  document.getElementById('medication').value ="";
  document.getElementById('notes').value ="";
  document.getElementById('prescription-info').value = ``;
});

document.getElementById('prescriptionForm').addEventListener('submit', function (event) {
  event.preventDefault();
  
  const prescriptionData = {
      id: document.getElementById('prescriptionId').value,
      appointment_id: document.getElementById('appointmentId').value,
      blood_pressure_systolic: document.getElementById('bloodPressure-sys').value,
      blood_pressure_diastolic: document.getElementById('bloodPressure-dias').value,
      diabetes: document.getElementById('diabetes').value,
      medication: document.getElementById('medication').value,
      notes: document.getElementById('notes').value
  };
  console.log(prescriptionData);

  fetch('/save_prescription/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
      body: JSON.stringify(prescriptionData)
  })
  .then(response => response.json())
  .then(data => {
      alert(data.message);
      document.getElementById('prescriptionModal').classList.add('hidden');
  })
  .catch(error => console.error('Error:', error));
});


function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}


function searchPatient() {
    let email = document.getElementById("searchEmail").value;
    fetch('/search-patient/', { 
        method: "POST", 
        body: JSON.stringify({ patient_email: email }),
        headers: { "Content-Type": "application/json" }
    })
    .then(response => response.json())
    .then(data => alert("Past records fetched!"));
}


let currentEmergencyId = null;
let currentPatientEmail = null;

function openLinkModal(id, patientEmail) {
  currentEmergencyId = id;
  currentPatientEmail = patientEmail;
  document.getElementById("meeting-link-input").value = "";
  document.getElementById("emergency-modal").classList.remove("hidden");
}

function closeEmergencyModal() {
  document.getElementById("emergency-modal").classList.add("hidden");
}

async function sendEmergencyLink() {
  const link = document.getElementById("meeting-link-input").value.trim();
  if (!link) return alert("Please enter a valid meeting link.");

  const response = await fetch("/api/send-emergency-link/", {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
    body: JSON.stringify({
      appointment_id: currentEmergencyId,
      patient_email: currentPatientEmail,
      meeting_link: link
    })
  });

  const result = await response.json();
  if (response.ok) {
    alert("Meeting link sent successfully!");
    closeEmergencyModal();
  } else {
    alert("Error sending link: " + result.error);
  }
}

function getCSRFToken() {
  return document.cookie.split("; ").find(row => row.startsWith("csrftoken="))?.split("=")[1];
}



      // Confirm Logout
  function confirmLogout() {
    if (confirm("Are you sure you want to logout?")) {
        window.location.href = "/logout/";
    }
}



// Navs and footer js

const menuToggle = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');

    menuToggle.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
    });

    document.getElementById('back-to-top').addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    // Show Popup with Map for Location and Pharmacy Tracker
    const popupBox = document.getElementById('popup-box');
    const mapFrame = document.getElementById('map');
    const closePopup = document.getElementById('close-popup');
    const popupTitle = document.getElementById('popup-title'); // Access the title element
    
    document.getElementById('location-link').addEventListener('click', (event) => {
        event.preventDefault();
        popupTitle.textContent = 'Our Location'; // Set the title for location
        mapFrame.src = 'https://www.google.com/maps/embed?pb=YOUR_EMBED_MAP_URL'; // Replace with your actual Google Maps embed link
        popupBox.classList.remove('hidden');
    });
    
    // Dynamic Nearby Pharmacy Tracker
    document.getElementById('track-pharmacy').addEventListener('click', (event) => {
      event.preventDefault();
      popupTitle.textContent = 'Nearby Pharmacy Tracker';

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;

          // Embed Google Maps pharmacy search near user's location
          const searchURL = `https://www.google.com/maps?q=pharmacy&ll=${lat},${lon}&z=15&output=embed`;
          mapFrame.src = searchURL;
          popupBox.classList.remove('hidden');
        }, () => {
          alert("Location permission denied or unavailable.");
        });
      } else {
        alert("Your browser does not support geolocation.");
      }
    });
    // Close Popup
    closePopup.addEventListener('click', () => {
        popupBox.classList.add('hidden');
        mapFrame.src = ''; // Clear the iframe src when popup closes
    });
    
    // Set Current Year
    document.getElementById('current-year').textContent = new Date().getFullYear();


  </script>
</body>
</html>
