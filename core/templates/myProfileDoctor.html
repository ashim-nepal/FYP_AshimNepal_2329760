<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doctor's Profile | {{doctor.name}}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Optional: Styling for the scrollbar in the working time section */
    ::-webkit-scrollbar {
      height: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #29622E;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-track {
      background-color: #f1f1f1;
    }
  </style>
</head>
<body class="bg-gray-50">

  <section>
    Nav here
    <button onclick="confirmLogout()" class="text-green-700 font-semibold hover:underline">Logout</button>
  </section>

  <section class="p-6">
    <header class="text-2xl text-[#29622E] font-bold text-center mb-8">
      {{ branch_name }} | Dr. {{ doctor.name }}
    </header>

    <div class="flex flex-wrap lg:flex-nowrap gap-6">

      <div class="flex flex-col items-center bg-white shadow-md p-6 rounded-lg w-full lg:w-1/3">

        <div class="w-36 h-36 bg-gray-200 rounded-full mb-4"></div>
        <p class="text-sm text-[#29622E] mb-4">NMC Registration No: {{ doctor.nmc_registration}}</p>



        <div class="mt-6">
          <p class="text-center mb-4 font-bold text-lg text-gray-700">My Rating‚≠ê: {{doctor.rating}} / 10</p>
        </div>


        <div id="rating-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white hidden rounded-lg shadow-lg p-6 w-11/12 max-w-md">
            <h2 class="text-lg font-bold text-[#29622E] mb-4"></h2>
            <div class="flex items-center justify-between">
            </div>
            <div class="flex justify-end mt-6 space-x-4">
            </div>
          </div>
        </div>
      </div>


      <div class="bg-white shadow-md p-6 rounded-lg w-full lg:w-2/3">
        <p class="mb-4"><span class="font-bold">Name:</span> Dr. {{doctor.name}}</p>
        <p class="mb-4"><span class="font-bold">Email:</span> {{doctor.email}}</p>
        <p class="mb-4"><span class="font-bold">Department:</span> {{doctor.department}}</p>
        <p class="mb-4"><span class="font-bold">Expertise:</span> {{doctor.expertise}}</p>
        <p class="mb-4"><span class="font-bold">Education:</span> {{doctor.education}}</p>
        <p class="mb-4"><span class="font-bold">Hospitals Worked:</span> {{doctor.hospitals_worked}}</p>
        <p class="mb-4"><span class="font-bold">Achievements:</span> {{doctor.achievements}}</p>
        <p class="font-bold mb-2">Working Time:</p>

  </section>


  <section id ="scheduling-section">

  <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-2xl font-bold mb-4 text-center">Set Your Availability</h2>
    
    <div id="schedule-container" class="space-y-4">


    </div>

    <button id="save-schedule"
        class="mt-6 w-150 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
        Save Availability
    </button>
</div>
</section>


  <section>
    Footer here
  </section>
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
    let scheduleContainer = document.getElementById("schedule-container");
    let saveButton = document.getElementById("save-schedule");
  
  
      async function fetchSchedule() {
        try{
          let response = await fetch("/api/get-doctor-schedule/{{ doctor.email}}/");
          console.log(response);


      let result = await response.json(); // Convert JSON only if valid response
      console.log(result);
  
          scheduleContainer.innerHTML = "";
  
          let days = result.schedule || [];
  
          for (let i = 0; i < 7; i++) {
              let day = days[i] || {
                  date: getFutureDate(i+2),
                  working_day_type: null,
                  is_locked: false
              };
  
              let isLocked = day.is_locked ? "disabled" : "";
              let selectedOption = day.working_day_type || "None"; // Handle new entries
              let emergencyChecked = day.emergency_available ? "checked" : "";
  
              let row = `
                  <div class="flex justify-between items-center mb-4 p-3 border border-gray-300 rounded">
                      <span class="font-semibold">${day.date}-${day.day}</span>
                      <select data-date="${day.date}" class="schedule-select w-48 p-2 border rounded" ${isLocked}>
                          <option value="None" ${selectedOption === "None" ? "selected" : ""}>Not Set</option>
                          <option value="Full" ${selectedOption === "Full" ? "selected" : ""}>Full Day</option>
                          <option value="Half_Morning" ${selectedOption === "Half_Morning" ? "selected" : ""}>Half Day - Morning</option>
                          <option value="Half_Evening" ${selectedOption === "Half_Evening" ? "selected" : ""}>Half Day - Evening</option>
                          <option value="Leave" ${selectedOption === "Leave" ? "selected" : ""}>Leave</option>
                      </select>
                      <label class="flex items-center space-x-2">
                        <input type="checkbox" data-date="${day.date}" class="emergency-checkbox" ${emergencyChecked} ${isLocked}>
                        <span>Emergency Available</span>
                    </label>
                  </div>`;
              scheduleContainer.innerHTML += row;
          }
      } catch(error){
        console.log(error);
      }
    
    }
  
      saveButton.addEventListener("click", async function () {
          let selects = document.querySelectorAll(".schedule-select");
          let checkboxes = document.querySelectorAll(".emergency-checkbox");
          let scheduleData = [];
  
          selects.forEach((select, index) => {
              let selectedValue = select.value !== "None" ? select.value : null;
              scheduleData.push({
                  date: select.getAttribute("data-date"),
                  working_day_type: selectedValue,
                  emergency_available: checkboxes[index].checked,
              });
          });
  
          let response = await fetch("/api/update-doctor-schedule/{{ doctor.email }}/", {
              method: "POST",
              headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
              body: JSON.stringify({ schedule: scheduleData })
          });

  
          let result = await response.json();
          document.getElementById("response-message").innerText = result.message || "Error updating schedule";
  
          fetchSchedule(); // Reload after saving
      });
  
      function getFutureDate(daysAhead) {
          let today = new Date();
          today.setDate(today.getDate() + daysAhead);
          return today.toISOString().split("T")[0];
      }
  
      function getCSRFToken() {
          return document.cookie.split("; ").find(row => row.startsWith("csrftoken="))?.split("=")[1];
      }
  
      fetchSchedule();
    });




      // Confirm Logout
  function confirmLogout() {
    if (confirm("Are you sure you want to logout?")) {
        window.location.href = "/logout/";
    }
}



  </script>
</body>
</html>
