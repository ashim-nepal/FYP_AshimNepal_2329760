<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Receptionist Dashboard - syncHealth</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- Header -->
  <header class="bg-white sticky top-0 z-50 shadow-md">
    <div class="container mx-auto flex justify-between items-center py-4 px-6">
      <h1 class="text-2xl font-bold text-700 text-[#29622E]">SyncHealth | {{ branch_name }}</h1>
      <button onclick="confirmLogout()" class="text-700 text-[#29622E] font-semibold hover:text-500 hover:text-[#35993E] transition">Logout</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto py-6 px-6">
    <h1 class="text-4xl font-bold mb-8 text-center text-[#29622E] text-800">syncHealth Receptionist</h1>

    <!-- Add New Patient Section -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
      <h3 class="text-xl font-bold text-gray-700 mb-4">Add New Patient</h3>
      <form id="add-patient-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700">Patient Name</label>
            <input type="text" id="patient-name" class="w-full border border-gray-300 rounded-lg p-2.5" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
            <input type="date" id="patient-dob" class="w-full border border-gray-300 rounded-lg p-2.5" required>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700">Age</label>
            <input type="number" id="patient-age" class="w-full border border-gray-300 rounded-lg p-2.5" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Gender</label>
            <select id="patient-gender" class="w-full border border-gray-300 rounded-lg p-2.5" required>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Address</label>
          <input type="text" id="patient-address" class="w-full border border-gray-300 rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Health Issues</label>
          <textarea id="patient-health-issues" class="w-full border border-gray-300 rounded-lg p-2.5"></textarea>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="patient-email" class="w-full border border-gray-300 rounded-lg p-2.5" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" id="patient-password" class="w-full border border-gray-300 rounded-lg p-2.5" required>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700">Department</label>
            <select id="department" class="w-full border border-gray-300 rounded-lg p-2.5" required></select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Assign Doctors</label>
            <select id="patient-doctors" class="w-full border border-gray-300 rounded-lg p-2.5" required></select>
          </div>
        </div>
        <input type="hidden" id="branch_id" value="{{ branch_code }}">
        <button type="submit" class="bg-[#29622E] hover:bg-[#35993E] text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">Add Patient</button>
      </form>
    </div>

    <button onclick="document.getElementById('booking-modal').classList.remove('hidden')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
      View Health Bookings
    </button>
    <br>

    <!-- All Patients Section -->
    <div class="bg-white mt-5 shadow rounded-lg p-6">
      <h3 class="text-xl font-bold text-gray-700 mb-4">All Patients</h3>
      <div class="overflow-x-auto">
        <input type="text" id="search-email" placeholder="Search by Email" class="w-full p-2 border border-gray-300 rounded mb-2">
        <table class="min-w-full border border-gray-300">
          <thead>
            <tr class="bg-gray-200 text-left text-sm font-semibold text-gray-700">
              <th class="px-6 py-3 border-b">Patient No</th>
              <th class="px-6 py-3 border-b">Name</th>
              <th class="px-6 py-3 border-b">Email</th>
              <th class="px-6 py-3 border-b">Branch</th>
              <th class="px-6 py-3 border-b">Age</th>
              <th class="px-6 py-3 border-b">Gender</th>
              <th class="px-6 py-3 border-b">Address</th>
              <th class="px-6 py-3 border-b">Health Issues</th>
              <th class="px-6 py-3 border-b">Doctors</th>
              <th class="px-6 py-3 border-b">Actions</th>
            </tr>
          </thead>
          <tbody id="patients-table">
            <!-- Dynamically populated -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

<!-- Edit Patient Modal -->
<div id="edit-patient-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center">
  <div class="bg-white w-96 p-6 rounded-lg shadow-lg">
    <h3 class="text-xl font-bold mb-4">Edit Patient</h3>
    <form id="edit-patient-form">
      <input type="hidden" id="edit-patient-id">
      
      <label class="block text-sm font-medium text-gray-700">New Address</label>
      <input type="text" id="edit-patient-address" class="w-full p-2 border border-gray-300 rounded" placeholder="Enter new address">
      
      <label class="block text-sm font-medium text-gray-700">New Health Issue</label>
      <input type="text" id="edit-health-issue" class="w-full p-2 border border-gray-300 rounded" placeholder="Add new health issue">
      
      <label class="block text-sm font-medium text-gray-700">Select Department</label>
      <select id="edit-patient-department" class="w-full p-2 border border-gray-300 rounded">
        <!-- Departments dynamically populated -->
      </select>
      
      <label class="block text-sm font-medium text-gray-700">Assign Additional Doctor</label>
      <select id="edit-patient-doctors" class="w-full p-2 border border-gray-300 rounded">
        <!-- Doctors dynamically populated -->
      </select>
      <input type="hidden" value="{{ branch_code }}" required>
      
      <div class="flex justify-end space-x-4 mt-6">
        <button type="button" id="close-edit-modal" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">Cancel</button>
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Update</button>
      </div>
    </form>
  </div>
</div>

<!-- Health Booking model -->
<div id="booking-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-lg w-full max-w-3xl">
    <h2 class="text-xl font-bold text-[#29622E] mb-4">Search Health Package Bookings</h2>
    <div class="flex gap-4 mb-4">
      <input id="search-receipt" type="text" placeholder="Search by Receipt ID"  class="w-full border px-3 py-2 rounded">
      <input id="search-by-email" type="text" placeholder="Search by Patient Email" class="w-full border px-3 py-2 rounded">
      <button onclick="searchBookings()" class="bg-[#29622E] text-white px-4 py-2 rounded">Search</button>
    </div>

    <table class="w-full text-sm border border-gray-300">
      <thead class="bg-gray-100">
        <tr class="text-[#29622E]">
          <th class="border px-2 py-1">Receipt ID</th>
          <th class="border px-2 py-1">Patient</th>
          <th class="border px-2 py-1">Package</th>
          <th class="border px-2 py-1">Branch</th>
          <th class="border px-2 py-1">Date</th>
          <th class="border px-2 py-1">Status</th>
          <th class="border px-2 py-1">Amount</th>
        </tr>
      </thead>
      <tbody id="booking-table-body"></tbody>
    </table>

    <button onclick="document.getElementById('booking-modal').classList.add('hidden')" class="mt-4 bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Close</button>
  </div>
</div>

  <!-- Footer -->
  <footer class="bg-gray-200 text-center py-4 mt-10">
    <p class="text-gray-600">&copy; 2025 syncHealth. All rights reserved.</p>
  </footer>

  <!-- JavaScript -->
  <script>
    document.getElementById("patient-dob").addEventListener("change", function() {
      const dob = new Date(this.value);
      const age = new Date().getFullYear() - dob.getFullYear();
      document.getElementById("patient-age").value = age;
    });


    document.getElementById("add-patient-form").addEventListener("submit", async (e) => {
      e.preventDefault();
  
      const formData = new FormData();
      formData.append("name", document.getElementById("patient-name").value);
      formData.append("age", document.getElementById("patient-age").value);
      formData.append("dob", document.getElementById("patient-dob").value);
      formData.append("gender", document.getElementById("patient-gender").value);
      formData.append("address", document.getElementById("patient-address").value);
      formData.append("health_issues", document.getElementById("patient-health-issues").value);
      formData.append("email", document.getElementById("patient-email").value);
      formData.append("password", document.getElementById("patient-password").value);
      formData.append("department_id", document.getElementById("department").value);
      formData.append("branch_id", "{{ branch_code }}");  // Set dynamically
  
      // Convert selected doctors to JSON string
      const selectedDoctors = Array.from(document.getElementById("patient-doctors").selectedOptions).map(opt => opt.value);
      formData.append("doctors", JSON.stringify(selectedDoctors));
  
      try {
          const response = await fetch("/api/add-patient/", {
              method: "POST",
              body: formData,
          });
  
          const data = await response.json();
          if (response.ok) {
              alert("Patient added successfully!");
              window.location.reload();
          } else {
              alert("Error: " + data.error);
          }
      } catch (error) {
          console.error("Error submitting form:", error);
          alert("Failed to submit patient details.");
      }
  });


  document.addEventListener("DOMContentLoaded", async function () {
    const departmentSelect = document.getElementById("department");
    const doctorSelect = document.getElementById("patient-doctors");
    const branchId = "{{ branch_code }}";  // Branch ID from logged-in Receptionist

    // Fetch Departments
    async function fetchDepartments() {
        try {
            const response = await fetch("/api/get-departments/");
            const departments = await response.json();
            const filteredDepartments = departments.departments.filter(
              (departments) => departments.branch_id === branchId
            );
            console.log(filteredDepartments);
            if (response.ok) {
              departmentSelect.innerHTML = '<option value="">Select Department</option>';
              filteredDepartments.forEach(dept => {
                  departmentSelect.innerHTML += `<option value="${dept.name}">${dept.name}</option>`;
              });
          } else {
              console.error("Error fetching departments:", data.error);
          }
        } catch (error) {
            console.error("Error fetching departments:", error);
        }
    }

    // Fetch Doctors When Department is Selected
    departmentSelect.addEventListener("change", async function () {
        doctorSelect.innerHTML = "";  // Clear previous data
        const departmentName = this.value;
        console.log(departmentName);
        console.log(branchId);
        if (!departmentName) return;

        try {
            const response = await fetch(`/api/get-doctors/${departmentName}/${branchId}/`);
            const doctors = await response.json();
            doctors.forEach(doc => {
                const option = document.createElement("option");
                option.value = doc.id;
                option.textContent = `${doc.name} (${doc.email})`;
                doctorSelect.appendChild(option);
            });
        } catch (error) {
            console.error("Error fetching doctors:", error);
        }
    });

    fetchDepartments();
});

let patientsData = [];

    async function fetchPatients() {
      let res = await fetch("/api/get-patients/");
      let patients = await res.json();
      console.log(patients);
      patientsData = patients;
      let tableBody = document.getElementById("patients-table");
      tableBody.innerHTML = "";
      patients.forEach(p => {
        let row = `<tr class="patient-row" data-email="${p.email}">
          <td>${p.patient_no}</td>
          <td>${p.name}</td>
          <td>${p.email}</td> 
          <td>${p.branch_name}</td>
          <td>${p.age}</td>
          <td>${p.gender}</td>
          <td>${p.address}</td>
          <td>${p.health_issues}</td> 
          <td>${p.assigned_doctors.map(doc => doc.name).join(", ")}</td>
          <td>
            <button onclick="editPatient('${p.id}', '${p.branch}')" class="text-blue-600 hover:underline">Edit</button>
            <button onclick="deletePatient('${p.email}')" class="text-red-600 hover:underline ml-2">Delete</button>
          </td>
        </tr>`;
        tableBody.innerHTML += row;
      });
    }

    fetchPatients();

    // Filter Doctors by NMC Number
document.addEventListener("input", (event) => {
  if (event.target.id === "search-email") {
      let searchValue = event.target.value.trim();
      document.querySelectorAll(".patient-row").forEach(row => {
          row.style.display = row.dataset.email.includes(searchValue) ? "" : "none";
      });
  }
});



// Fetch Departments for Editing
async function fetchEditDepartments() {
  const branchId = "{{ branch_code }}";
  try {
      const response = await fetch("/api/get-departments/");
      const data = await response.json();
      const filteredDepartments = data.departments.filter(dept => dept.branch_id === branchId);
      
      const editDepartmentSelect = document.getElementById("edit-patient-department");
      editDepartmentSelect.innerHTML = '<option value="">Select Department</option>';

      filteredDepartments.forEach(dept => {
          editDepartmentSelect.innerHTML += `<option value="${dept.name}">${dept.name}</option>`;
      });

  } catch (error) {
      console.error("Error fetching departments:", error);
  }
}

// Fetch Doctors Based on Selected Department in Edit Modal
document.getElementById("edit-patient-department").addEventListener("change", async function () {
  const editDoctorSelect = document.getElementById("edit-patient-doctors");
  editDoctorSelect.innerHTML = ""; // Clear previous data
  const departmentName = this.value;
  const branchId =  "{{ branch_code }}"; // Assuming branch is stored in dataset

  if (!departmentName) return;

  try {
      const response = await fetch(`/api/get-doctors/${departmentName}/${branchId}/`);
      const doctors = await response.json();
      
      doctors.forEach(doc => {
          const option = document.createElement("option");
          option.value = JSON.stringify({ email: doc.email, name: doc.name });
          option.textContent = `${doc.name} (${doc.email})`;
          editDoctorSelect.appendChild(option);
      });

  } catch (error) {
      console.error("Error fetching doctors:", error);
  }
});

// Open Edit Modal & Populate Fields
function editPatient(patientId) {
  const branchId = "{{ branch_code }}";
  fetchEditDepartments(); // Fetch departments
  let patient = patientsData.find(p => p.id === patientId); // Use global patientsData

  if (!patient) {
    console.error("Patient not found!");
    return;
  }
  document.getElementById("edit-patient-id").value = patientId;
  document.getElementById("edit-patient-id").dataset.branch = patient.branch_id; // Store branch ID
  document.getElementById("edit-patient-address").value = patient.address;
  document.getElementById("edit-health-issue").value = "";

  
  document.getElementById("edit-patient-modal").classList.remove("hidden");
}

function getCSRFToken() {
  const name = "csrftoken";
  const cookies = document.cookie.split(";");

  for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith(name + "=")) {
          return cookie.substring(name.length + 1);
      }
  }
  return "";
}

// Submit Edit Patient Form
document.getElementById("edit-patient-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const patientId = document.getElementById("edit-patient-id").value;
  const address = document.getElementById("edit-patient-address").value;
  const healthIssue = document.getElementById("edit-health-issue").value;
  
  // Get Selected New Doctors
    const selectedDoctors = Array.from(document.getElementById("edit-patient-doctors").selectedOptions).map(opt => {
      try {
          const doctorData = JSON.parse(opt.value); // Parse the JSON string
          return {
              email: doctorData.email,
              name: doctorData.name
          };
      } catch (error) {
          console.error("Error parsing JSON:", error, opt.value); // Handle parsing errors
          return null; // Or handle the error as appropriate
      }
  });
  console.log(selectedDoctors);

  const editData = {
      address: address,
      health_issue: healthIssue,
      assigned_doctors: selectedDoctors
  };

  try {
      const response = await fetch(`/api/edit-patient/${patientId}/`, {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCSRFToken()
          },
          body: JSON.stringify(editData)
      });

      const result = await response.json();

      if (response.ok) {
          alert("Patient updated successfully!");
          document.getElementById("edit-patient-modal").classList.add("hidden"); // Close modal
          fetchPatients(); // Refresh table
      } else {
          alert("Error updating patient: " + result.error);
      }
  } catch (error) {
      console.error("Failed to update patient:", error);
      alert("An unexpected error occurred. Please try again.");
  }
});


// Close Edit Modal
document.getElementById("close-edit-modal").addEventListener("click", () => {
  document.getElementById("edit-patient-modal").classList.add("hidden");
});


async function deletePatient(email) {
  if (!confirm(`Are you sure you want to delete this patient's login credentials?`)) return;

  try {
      const response = await fetch(`/api/delete-patient/${email}/`, {
          method: "DELETE",
          headers: {
              "X-CSRFToken": getCSRFToken()
          }
      });

      const result = await response.json();

      if (response.ok) {
          alert("Patient login credentials deleted successfully!");
          fetchPatients(); // Refresh the patient table
      } else {
          alert("Error deleting patient: " + result.error);
      }
  } catch (error) {
      console.error("Failed to delete patient:", error);
      alert("An unexpected error occurred. Please try again.");
  }
}


async function searchBookings() {
  const receipt = document.getElementById("search-receipt").value;
  const email = document.getElementById("search-by-email").value;

  const res = await fetch(`/api/health-bookings/?receipt_id=${receipt}&email=${email}`);
  const data = await res.json();

  const table = document.getElementById("booking-table-body");
  table.innerHTML = "";

  data.forEach(booking => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="border px-2 py-1">${booking.receipt_id}</td>
      <td class="border px-2 py-1">${booking.patient}</td>
      <td class="border px-2 py-1">${booking.test_name}</td>
      <td class="border px-2 py-1">${booking.branch}</td>
      <td class="border px-2 py-1">${booking.test_date}</td>
      <td class="border px-2 py-1">
        <select onchange="updateStatus('${booking.receipt_id}', this.value)" class="border px-1 py-1 rounded text-sm">
          <option ${booking.status === 'Pending' ? 'selected' : ''}>Pending</option>
          <option ${booking.status === 'Approved' ? 'selected' : ''}>Approved</option>
          <option ${booking.status === 'Processing' ? 'selected' : ''}>Processing</option>
          <option ${booking.status === 'Completed' ? 'selected' : ''}>Completed</option>
          <option ${booking.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
        </select>
      </td>
      <td class="border px-2 py-1">Rs. ${booking.amount}</td>
    `;
    table.appendChild(row);
  });
}

async function updateStatus(receiptId, newStatus) {
  if (!confirm(`Change status to ${newStatus}?`)) return;

  const res = await fetch(`/api/update-health-booking-status/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCSRFToken()
    },
    body: JSON.stringify({ receipt_id: receiptId, new_status: newStatus })
  });

  const result = await res.json();
  alert(result.message || result.error);
}

function getCSRFToken() {
  return document.cookie.split("; ").find(row => row.startsWith("csrftoken="))?.split("=")[1];
}



  // Confirm Logout
  function confirmLogout() {
    if (confirm("Are you sure you want to logout?")) {
        window.location.href = "/logout/";
    }
}
  </script>
</body>
</html>
