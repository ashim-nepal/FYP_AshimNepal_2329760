<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CT Scan Centre</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

    <!-- Header -->
    <div class="flex justify-between items-center mb-6 border-b-2 pb-2 border-black">
        <h1 class="text-2xl font-bold text-green-700">Test Centre</h1>
        <button onclick="confirmLogout()" class="text-green-700 font-semibold">Logout</button>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-6">
            <!-- Pending -->
            <div id="pendingBox" class="bg-white border border-black p-4 rounded-lg">
                <h2 class="text-lg font-bold text-green-700 mb-4">Pending Approvals</h2>
                <input type="text" placeholder="Search by email" oninput="filterRecords('pendingBox')" class="mb-2 w-full p-2 border rounded" />
                <input type="date" oninput="filterRecords('pendingBox')" class="mb-4 w-full p-2 border rounded" />
                <div id="pendingBox-records" class="space-y-3 overflow-auto h-48"></div>
            </div>

            <!-- Approved -->
            <div id="approvedBox" class="bg-white border border-black p-4 rounded-lg">
                <h2 class="text-lg font-bold text-green-700 mb-4">Approved Tests (Update Status)</h2>
                <input type="text" placeholder="Search by email" oninput="filterRecords('approvedBox')" class="mb-2 w-full p-2 border rounded" />
                <input type="date" oninput="filterRecords('approvedBox')" class="mb-4 w-full p-2 border rounded" />
                <div id="approvedBox-records" class="space-y-3 overflow-auto h-48"></div>
            </div>
        </div>

        <!-- Completed -->
        <div id="completedBox" class="bg-white border border-black p-4 rounded-lg">
            <h2 class="text-lg font-bold text-green-700 mb-4">Completed Tests (Upload Report)</h2>
            <input type="text" placeholder="Search by email" oninput="filterRecords('completedBox')" class="mb-2 w-full p-2 border rounded" />
            <input type="date" oninput="filterRecords('completedBox')" class="mb-4 w-full p-2 border rounded" />
            <div id="completedBox-records" class="space-y-3 overflow-auto h-48"></div>
        </div>
    </div>

    <br><br>
    <button onclick="toggleModal()" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-900">View Past Logs</button>

    <!-- Modal -->
    <div id="logModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white w-full max-w-3xl rounded-xl shadow-xl p-6 relative">
            <button onclick="toggleModal()" class="absolute top-3 right-3 text-xl">‚ùå</button>
            <h3 class="text-xl font-bold mb-4">Past Test Logs</h3>
            <input type="text" placeholder="Search by email" oninput="filterRecords('pastBox')" class="mb-2 w-full p-2 border rounded" />
            <input type="date" oninput="filterRecords('pastBox')" class="mb-4 w-full p-2 border rounded" />
            <div id="pastBox-records" class="space-y-2 max-h-[400px] overflow-y-auto"></div>
        </div>
    </div>

<script>
    async function fetchAppointments() {
        const response = await fetch("/api/get-tc-appointments/");
        const data = await response.json();

        const filteredData = data.appointments.filter(app => app.test_department === "{{testcnt_email}}");

        const boxes = {
            "Pending": document.getElementById("pendingBox-records"),
            "Approved": document.getElementById("approvedBox-records"),
            "Sample Collected": document.getElementById("approvedBox-records"),
            "Processing": document.getElementById("approvedBox-records"),
            "Completed": document.getElementById("completedBox-records"),
        };

        for (let box of Object.values(boxes)) box.innerHTML = "";
        console.log(filteredData);

        filteredData.forEach(app => {
            const div = document.createElement("div");
            div.className = "border p-3 rounded-lg";
            div.setAttribute("data-email", app.patient.toLowerCase());
            div.setAttribute("data-date", app.booking_date);

            div.innerHTML = `
                <p class="font-semibold text-green-700">${app.booking_date}</p>
                <p>${app.patient} | ${app.test_department}</p>
            `;

            if (app.status === "Pending") {
                div.innerHTML += `
                    <button class="bg-green-700 text-white px-2 py-1 rounded-lg approve-btn" data-id="${app.id}">Approve</button>
                    <button class="bg-red-700 text-white px-2 py-1 rounded-lg reject-btn" data-id="${app.id}">Reject</button>
                `;
            }

            if (["Approved", "Sample Collected", "Processing"].includes(app.status)) {
                div.innerHTML += `
                    <select class="border px-2 py-1 rounded-lg status-dropdown" data-id="${app.id}">
                        <option value="Approved" ${app.status === "Approved" ? "selected" : ""}>Approved</option>
                        <option value="Sample Collected" ${app.status === "Sample Collected" ? "selected" : ""}>Sample Collected</option>
                        <option value="Processing" ${app.status === "Processing" ? "selected" : ""}>Processing</option>
                        <option value="Completed">Completed</option>
                    </select>
                `;
            }

            if (app.status === "Completed") {
                div.innerHTML += `
                    <button class="bg-blue-700 text-white px-2 py-1 rounded-lg upload-btn" data-id="${app.id}">Upload Report</button>
                `;
            }

            boxes[app.status]?.appendChild(div);
        });

        attachEventListeners();
    }

    function attachEventListeners() {
        document.querySelectorAll(".approve-btn").forEach(btn => {
            btn.onclick = async function () {
                const id = this.dataset.id;
                await fetch("/api/update-tc-status/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id, status: "Approved" }),
                });
                fetchAppointments();
            };
        });

        document.querySelectorAll(".reject-btn").forEach(btn => {
            btn.onclick = async function () {
                const id = this.dataset.id;
                const reason = prompt("Enter rejection reason:");
                await fetch("/api/reject-test-req/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id, reason }),
                });
                fetchAppointments();
            };
        });

        document.querySelectorAll(".status-dropdown").forEach(select => {
            select.onchange = async function () {
                const id = this.dataset.id;
                const status = this.value;
                if (confirm(`Change status to ${status}?`)) {
                    await fetch("/api/update-tc-status/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ id, status }),
                    });
                    fetchAppointments();
                }
            };
        });

        document.querySelectorAll(".upload-btn").forEach(btn => {
            btn.onclick = function () {
                const id = this.dataset.id;
                const input = document.createElement("input");
                input.type = "file";
                input.accept = ".pdf";
                input.onchange = async function () {
                    const file = input.files[0];
                    if (!file) return;
                    const formData = new FormData();
                    formData.append("id", id);
                    formData.append("report_file", file);
                    await fetch("/api/send-test-report/", { method: "POST", body: formData });
                    alert("Report uploaded and email sent!");
                    fetchAppointments();
                };
                input.click();
            };
        });
    }

    function filterRecords(boxId) {
        const email = document.querySelector(`#${boxId} input[type="text"]`).value.toLowerCase();
        const date = document.querySelector(`#${boxId} input[type="date"]`).value;
        const list = document.getElementById(`${boxId}-records`);
        console.log(list);
        [...list.children].forEach(el => {
            const matchEmail = el.dataset.email.includes(email);
            const matchDate = !date || el.dataset.date === date;
            el.style.display = matchEmail && matchDate ? "block" : "none";
        });
    }

    function toggleModal() {
        const modal = document.getElementById("logModal");
        modal.classList.toggle("hidden");
        if (!modal.classList.contains("hidden")) renderRecords("pastBox");
    }

    async function renderRecords(boxId) {
        const response = await fetch("/api/get-tc-appointments/");
        const data = await response.json();
        const container = document.getElementById(`${boxId}-records`);
        container.innerHTML = "";

        const records = data.appointments.filter(app =>
            ["Cancelled", "Completion Notified"].includes(app.status)
        ).sort((a, b) => new Date(b.booking_date) - new Date(a.booking_date));

        records.forEach(app => {
            const div = document.createElement("div");
            div.className = "border p-2 rounded";
            div.setAttribute("data-email", app.patient.toLowerCase());
            div.setAttribute("data-date", app.booking_date);
            div.innerHTML = `
                <p class="text-green-700">${app.booking_date}</p>
                <p>${app.patient} - ${app.status}</p>
                ${app.report_file ? `<a href="${app.report_file}" target="_blank" class="text-blue-600 underline">View Report</a>` : ""}
            `;
            container.appendChild(div);
        });
    }

    function confirmLogout() {
        if (confirm("Are you sure you want to logout?")) {
            window.location.href = "/logout/";
        }
    }

    fetchAppointments();
</script>
</body>
</html>

















{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CT Scan Centre</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

    <!-- Header -->
    <div class="flex justify-between items-center mb-6 border-b-2 pb-2 border-black">
        <h1 class="text-2xl font-bold text-green-700">Test Centre</h1>
        <button onclick="confirmLogout()" class="text-green-700 font-semibold">Logout</button>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Left Section: Pending/Approved Tests -->
        <div class="space-y-6">
            <!-- Pending Approvals -->
            <div class="bg-white border border-black p-4 rounded-lg">
                <h2 class="text-lg font-bold text-green-700 mb-4">Pending Approvals</h2>
                <input type="text" placeholder="Search by email" oninput="filterRecords('pendingBox')" class="mb-2 w-full p-2 border rounded" />
                <input type="date" oninput="filterRecords('pendingBox')" class="mb-4 w-full p-2 border rounded" />
                <div id="pending-list" class="space-y-3 overflow-auto h-48"></div>
            </div>

            <!-- Approved Tests -->
            <div class="bg-white border border-black p-4 rounded-lg">
                <h2 class="text-lg font-bold text-green-700 mb-4">Approved Tests (Update Status)</h2>
                <input type="text" placeholder="Search by email" oninput="filterRecords('approvedBox')" class="mb-2 w-full p-2 border rounded" />
                <input type="date" oninput="filterRecords('approvedBox')" class="mb-4 w-full p-2 border rounded" />
                <div id="approved-status-list" class="space-y-3 overflow-auto h-48"></div>
            </div>
        </div>

        <!-- Right Section: Completed Reports -->
        <div class="bg-white border border-black p-4 rounded-lg">
            <h2 class="text-lg font-bold text-green-700 mb-4">Completed Tests (Upload Report)</h2>
            <input type="text" placeholder="Search by email" oninput="filterRecords('completedBox')" class="mb-2 w-full p-2 border rounded" />
            <input type="date" oninput="filterRecords('completedBox')" class="mb-4 w-full p-2 border rounded" />
            <div id="completed-list" class="space-y-3 overflow-auto h-48"></div>
        </div>
    </div>
    <br>
    <br>
    <button onclick="toggleModal()" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-900">
        View Past Logs
      </button>

        <!-- Modal -->
  <div id="logModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white w-full max-w-3xl rounded-xl shadow-xl p-6 relative">
      <button onclick="toggleModal()" class="absolute top-3 right-3 text-xl">‚úñÔ∏è</button>
      <h3 class="text-xl font-bold mb-4">Past Test Logs</h3>
      <input type="text" placeholder="Search by email" oninput="filterRecords('pastBox')" class="mb-2 w-full p-2 border rounded" />
      <input type="date" oninput="filterRecords('pastBox')" class="mb-4 w-full p-2 border rounded" />
      <div id="pastBox-records" class="space-y-2 max-h-[400px] overflow-y-auto">
        <!-- Injected past records -->
      </div>
    </div>
  </div>



    <script>
        async function fetchAppointments() {
            let response = await fetch("/api/get-tc-appointments/");
            let data = await response.json();
            let pendingList = document.getElementById("pending-list");
            let approvedList = document.getElementById("approved-status-list");
            let completedList = document.getElementById("completed-list");

            pendingList.innerHTML = "";
            approvedList.innerHTML = "";
            completedList.innerHTML = "";
            console.log(data);
            const filteredData = data.appointments.filter(
                (appointments)=>appointments.test_department === "{{testcnt_email}}"
            );
            console.log(filteredData);

            filteredData.forEach(app => {
                let div = document.createElement("div");
                div.className = "border p-3 rounded-lg";
                div.innerHTML = `
                    <p class="font-semibold text-green-700">${app.booking_date}</p>
                    <p>${app.patient} | ${app.test_department}</p>
                `;

                if (app.status === "Pending") {
                    div.innerHTML += `
                        <button class="bg-green-700 text-white px-2 py-1 rounded-lg approve-btn" data-id="${app.id}">Approve</button>
                        <button class="bg-red-700 text-white px-2 py-1 rounded-lg reject-btn" data-id="${app.id}">Reject</button>
                    `;
                    pendingList.appendChild(div);
                } else if (app.status === "Approved" || app.status === "Sample Collected" || app.status === "Processing") {
                    div.innerHTML += `
                        <select class="border px-2 py-1 rounded-lg status-dropdown" data-id="${app.id}">
                            <option value="Approved" ${app.status === "Approved" ? "selected" : ""}>Approved</option>
                            <option value="Sample Collected" ${app.status === "Sample Collected" ? "selected" : ""}>Sample Collected</option>
                            <option value="Processing" ${app.status === "Processing" ? "selected" : ""}>Processing</option>
                            <option value="Completed">Completed</option>
                        </select>
                    `;
                    approvedList.appendChild(div);
                } else if (app.status === "Completed") {
                    div.innerHTML += `
                        <button class="bg-blue-700 text-white px-2 py-1 rounded-lg upload-btn" data-id="${app.id}">Upload Report</button>
                    `;
                    completedList.appendChild(div);
                }
            });

            document.querySelectorAll(".approve-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    let testId = this.getAttribute("data-id");
                    await fetch("/api/update-tc-status/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ id: testId, status: "Approved" })
                    });
                    fetchAppointments();
                });
            });

            document.querySelectorAll(".reject-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    let testId = this.getAttribute("data-id");
                    let reason = prompt("Enter rejection reason:");
                    await fetch("/api/reject-test-req/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ id: testId, reason: reason })
                    });
                    fetchAppointments();
                });
            });

            document.querySelectorAll(".status-dropdown").forEach(select => {
                select.addEventListener("change", async function () {
                    let testId = this.getAttribute("data-id");
                    let newStatus = this.value;

                    let confirmChange = confirm(`Are you sure you want to change the status to ${newStatus}?`);
                    if (confirmChange) {
                        await fetch("/api/update-tc-status/", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ id: testId, status: newStatus })
                        });
                        fetchAppointments();
                    }
                });
            });

            document.querySelectorAll(".upload-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    let testId = this.getAttribute("data-id");
                    let fileInput = document.createElement("input");
                    fileInput.type = "file";
                    fileInput.accept = ".pdf";
                    fileInput.onchange = async function () {
                        let file = fileInput.files[0];
                        if (!file) return;

                        let formData = new FormData();
                        formData.append("id", testId);
                        formData.append("report_file", file);

                        await fetch("/api/send-test-report/", {
                            method: "POST",
                            body: formData
                        });

                        alert("Report uploaded and email sent!");
                        fetchAppointments();
                    };
                    fileInput.click();
                });
            });
        }

        fetchAppointments();


        function filterRecords(boxId) {
            const emailInput = document.querySelector(`#${boxId} input[type="text"]`);
            const dateInput = document.querySelector(`#${boxId} input[type="date"]`);
            const emailValue = emailInput.value.toLowerCase();
            const dateValue = dateInput.value;
      
            const container = document.getElementById(`${boxId}-records`);
            for (const item of container.children) {
              const matchesEmail = item.dataset.email.includes(emailValue);
              const matchesDate = dateValue ? item.dataset.date === dateValue : true;
              item.style.display = matchesEmail && matchesDate ? "block" : "none";
            }
          }

          function toggleModal() {
            document.getElementById("logModal").classList.toggle("hidden");
            renderRecords("pastBox");
          }

        // Confirm Logout
  function confirmLogout() {
    if (confirm("Are you sure you want to logout?")) {
        window.location.href = "/logout/";
    }
}
    </script>

</body>
</html>
 {% endcomment %}
