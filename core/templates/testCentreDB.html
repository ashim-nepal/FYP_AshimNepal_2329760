<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{tc_details.name}} Dashboard - syncHealth</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/media/images/favicon-32x32.png">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-white sticky top-0 z-50 shadow-md">
    <div class="container mx-auto flex justify-between items-center py-4 px-6">
      <h1 class="text-2xl font-bold text-700 text-[#29622E]">{{tc_details.name}} | {{ tc_details.branch }}</h1>
      <button onclick="confirmLogout()" class="text-700 text-[#29622E] font-semibold hover:text-500 hover:text-[#35993E] transition">Logout</button>
    </div>
  </header>

    <!-- Main Grid -->
     <h1 class="text-4xl mt-5 font-bold mb-8 text-center text-[#29622E] text-800">syncHealth Test Centre</h1>
    <div class="grid mt-4 p-10 grid-cols-1 md:grid-cols-2 gap-6">
        
        <div class="space-y-6">
            <!-- Pending -->
            <div id="pendingBox" class="bg-white border border-black p-4 rounded-lg">
                <h2 class="text-lg font-bold text-green-700 mb-4">Pending Approvals</h2>
                <input type="text" placeholder="Search by email" oninput="filterRecords('pendingBox')" class="mb-2 w-full p-2 border rounded" />
                <input type="date" oninput="filterRecords('pendingBox')" class="mb-4 w-full p-2 border rounded" />
                <div id="pendingBox-records" class="space-y-3 overflow-auto h-48"></div>
            </div>

            <!-- Approved -->
            <div id="approvedBox" class="bg-white border border-black p-4 rounded-lg">
                <h2 class="text-lg font-bold text-green-700 mb-4">Approved Tests (Update Status)</h2>
                <input type="text" placeholder="Search by email" oninput="filterRecords('approvedBox')" class="mb-2 w-full p-2 border rounded" />
                <input type="date" oninput="filterRecords('approvedBox')" class="mb-4 w-full p-2 border rounded" />
                <div id="approvedBox-records" class="space-y-3 overflow-auto h-48"></div>
            </div>
        </div>

        <!-- Completed -->
        <div id="completedBox" class="bg-white border border-black p-4 rounded-lg">
            <h2 class="text-lg font-bold text-green-700 mb-4">Completed Tests (Upload Report)</h2>
            <input type="text" placeholder="Search by email" oninput="filterRecords('completedBox')" class="mb-2 w-full p-2 border rounded" />
            <input type="date" oninput="filterRecords('completedBox')" class="mb-4 w-full p-2 border rounded" />
            <div id="completedBox-records" class="space-y-3 overflow-auto h-48"></div>
        </div>
    </div>

    <button onclick="toggleModal()" class="m-6 bg-green-700 text-white px-4 py-2 rounded hover:bg-green-900">View Past Logs</button>

    <footer class="bg-gray-200 text-center py-4 mt-10">
    <p class="text-gray-600">&copy; 2025 syncHealth. All rights reserved.</p>
  </footer>

    <!-- Modal -->
    <div id="logModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white w-full max-w-3xl rounded-xl shadow-xl p-6 relative">
            <button onclick="toggleModal()" class="absolute top-3 right-3 text-xl">❌</button>
            <h3 class="text-xl text-green-700 font-bold mb-4">Past Test Logs</h3>
            <input type="text" placeholder="Search by email" oninput="filterRecords('pastBox')" class="mb-2 w-full p-2 border rounded" />
            <input type="date" oninput="filterRecords('pastBox')" class="mb-4 w-full p-2 border rounded" />
            <div id="pastBox-records" class="space-y-2 max-h-[400px] overflow-y-auto"></div>
        </div>
    </div>

<script>
    async function fetchAppointments() {
        const response = await fetch("/api/get-tc-appointments/");
        const data = await response.json();

        const filteredData = data.appointments.filter(app => app.test_department === "{{testcnt_email}}");

        const boxes = {
            "Pending": document.getElementById("pendingBox-records"),
            "Approved": document.getElementById("approvedBox-records"),
            "Sample Collected": document.getElementById("approvedBox-records"),
            "Processing": document.getElementById("approvedBox-records"),
            "Completed": document.getElementById("completedBox-records"),
        };

        for (let box of Object.values(boxes)) box.innerHTML = "";
        console.log(filteredData);

        filteredData.forEach(app => {
            const div = document.createElement("div");
            div.className = "border p-3 rounded-lg";
            div.setAttribute("data-email", app.patient.toLowerCase());
            div.setAttribute("data-date", app.booking_date);

            div.innerHTML = `
                <p class="font-semibold text-green-700">${app.booking_date}</p>
                <p>${app.patient} | ${app.test_department}</p>
            `;

            if (app.status === "Pending") {
                div.innerHTML += `
                    <button class="bg-green-700 text-white px-2 py-1 rounded-lg approve-btn" data-id="${app.id}">Approve</button>
                    <button class="bg-red-700 text-white px-2 py-1 rounded-lg reject-btn" data-id="${app.id}">Reject</button>
                `;
            }

            if (["Approved", "Sample Collected", "Processing"].includes(app.status)) {
                div.innerHTML += `
                    <select class="border px-2 py-1 rounded-lg status-dropdown" data-id="${app.id}">
                        <option value="Approved" ${app.status === "Approved" ? "selected" : ""}>Approved</option>
                        <option value="Sample Collected" ${app.status === "Sample Collected" ? "selected" : ""}>Sample Collected</option>
                        <option value="Processing" ${app.status === "Processing" ? "selected" : ""}>Processing</option>
                        <option value="Completed">Completed</option>
                    </select>
                `;
            }

            if (app.status === "Completed") {
                div.innerHTML += `
                    <button class="bg-blue-700 text-white px-2 py-1 rounded-lg upload-btn" data-id="${app.id}">Upload Report</button>
                `;
            }

            boxes[app.status]?.appendChild(div);
        });

        attachEventListeners();
    }

    function attachEventListeners() {
        document.querySelectorAll(".approve-btn").forEach(btn => {
            btn.onclick = async function () {
                const id = this.dataset.id;
                await fetch("/api/update-tc-status/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id, status: "Approved" }),
                });
                fetchAppointments();
            };
        });

        document.querySelectorAll(".reject-btn").forEach(btn => {
            btn.onclick = async function () {
                const id = this.dataset.id;
                const reason = prompt("Enter rejection reason:");
                await fetch("/api/reject-test-req/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id, reason }),
                });
                fetchAppointments();
            };
        });

        document.querySelectorAll(".status-dropdown").forEach(select => {
            select.onchange = async function () {
                const id = this.dataset.id;
                const status = this.value;
                if (confirm(`Change status to ${status}?`)) {
                    await fetch("/api/update-tc-status/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ id, status }),
                    });
                    fetchAppointments();
                }
            };
        });

        document.querySelectorAll(".upload-btn").forEach(btn => {
            btn.onclick = function () {
                const id = this.dataset.id;
                const input = document.createElement("input");
                input.type = "file";
                input.accept = ".pdf";
                input.onchange = async function () {
                    const file = input.files[0];
                    if (!file) return;
                    const formData = new FormData();
                    formData.append("id", id);
                    formData.append("report_file", file);
                    await fetch("/api/send-test-report/", { method: "POST", body: formData });
                    alert("Report uploaded and email sent!");
                    fetchAppointments();
                };
                input.click();
            };
        });
    }

    function filterRecords(boxId) {
        const email = document.querySelector(`#${boxId} input[type="text"]`).value.trim().toLowerCase();
        const date = document.querySelector(`#${boxId} input[type="date"]`).value;
        const list = document.getElementById(`${boxId}-records`);
        console.log(list);
        [...list.children].forEach(el => {
            const elEmail = (el.dataset.email || "").toLowerCase();
            const elDate = el.dataset.date || "";

            const matchEmail = email === "" || elEmail.includes(email);
            const matchDate = date === "" || elDate === date;

            el.style.display = matchEmail && matchDate ? "block" : "none";
        });
    }

    function toggleModal() {
        const modal = document.getElementById("logModal");
        modal.classList.toggle("hidden");
        if (!modal.classList.contains("hidden")) renderRecords("pastBox");
    }

    async function renderRecords(boxId) {
        const response = await fetch("/api/get-tc-appointments/");
        const data = await response.json();
        const container = document.getElementById(`${boxId}-records`);
        container.innerHTML = "";

        const records = data.appointments.filter(app =>
            ["Cancelled", "Completion Notified"].includes(app.status)
        ).sort((a, b) => new Date(b.booking_date) - new Date(a.booking_date));

        console.log(records);
        records.forEach(app => {
            const div = document.createElement("div");
            div.className = "border p-2 rounded";
            div.setAttribute("data-email", app.patient.toLowerCase());
            div.setAttribute("data-date", app.booking_date);
            div.innerHTML = `
                <div class="bg-white border rounded-xl shadow-lg p-4 mb-4 space-y-3 hover:shadow-xl transition-all duration-300">
                    
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-semibold text-gray-600">Booking Date:</span>
                        <p class="text-green-700 font-medium">${app.booking_date}</p>
                    </div>

                    
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-semibold text-gray-600">Patient:</span>
                        <a href="/viewPatientProfile/${app.patient}" target="_blank" class="text-blue-700 hover:underline font-medium">
                        ${app.patient}
                        </a>
                        <span class="text-sm font-semibold text-gray-500">•</span>
                        <span class="text-sm font-semibold text-gray-800">Status:</span>
                        <span class="text-sm text-gray-700">${app.status}</span>
                    </div>

                    
                    ${app.test_report ? `
                        <div>
                        <a href="/media/${app.test_report}" target="_blank" 
                            class="inline-block px-4 py-2 bg-green-700 text-white rounded-lg shadow hover:bg-green-800 transition">
                            View Report
                        </a>
                        </div>` : ""}
                    </div>
            `;
            container.appendChild(div);
        });
    }

    function confirmLogout() {
        if (confirm("Are you sure you want to logout?")) {
            window.location.href = "/logout/";
        }
    }

    fetchAppointments();
</script>
</body>
</html>


