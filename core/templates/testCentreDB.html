<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CT Scan Centre</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

    <!-- Header -->
    <div class="flex justify-between items-center mb-6 border-b-2 pb-2 border-black">
        <h1 class="text-2xl font-bold text-green-700">Test Centre</h1>
        <button onclick="confirmLogout()" class="text-green-700 font-semibold">Logout</button>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Left Section: Pending/Approved Tests -->
        <div class="space-y-6">
            <!-- Pending Approvals -->
            <div class="bg-white border border-black p-4 rounded-lg">
                <h2 class="text-lg font-bold text-green-700 mb-4">Pending Approvals</h2>
                <div id="pending-list" class="space-y-3 overflow-auto h-48"></div>
            </div>

            <!-- Approved Tests -->
            <div class="bg-white border border-black p-4 rounded-lg">
                <h2 class="text-lg font-bold text-green-700 mb-4">Approved Tests (Update Status)</h2>
                <div id="approved-status-list" class="space-y-3 overflow-auto h-48"></div>
            </div>
        </div>

        <!-- Right Section: Completed Reports -->
        <div class="bg-white border border-black p-4 rounded-lg">
            <h2 class="text-lg font-bold text-green-700 mb-4">Completed Tests (Upload Report)</h2>
            <div id="completed-list" class="space-y-3 overflow-auto h-48"></div>
        </div>
    </div>

    <script>
        async function fetchAppointments() {
            let response = await fetch("/api/get-tc-appointments/");
            let data = await response.json();
            let pendingList = document.getElementById("pending-list");
            let approvedList = document.getElementById("approved-status-list");
            let completedList = document.getElementById("completed-list");

            pendingList.innerHTML = "";
            approvedList.innerHTML = "";
            completedList.innerHTML = "";
            console.log(data);
            const filteredData = data.appointments.filter(
                (appointments)=>appointments.test_department === "{{testcnt_email}}"
            );
            console.log(filteredData);

            filteredData.appointments.forEach(app => {
                let div = document.createElement("div");
                div.className = "border p-3 rounded-lg";
                div.innerHTML = `
                    <p class="font-semibold text-green-700">${app.booking_date}</p>
                    <p>${app.patient} | ${app.test_department}</p>
                `;

                if (app.status === "Pending") {
                    div.innerHTML += `
                        <button class="bg-green-700 text-white px-2 py-1 rounded-lg approve-btn" data-id="${app.id}">Approve</button>
                        <button class="bg-red-700 text-white px-2 py-1 rounded-lg reject-btn" data-id="${app.id}">Reject</button>
                    `;
                    pendingList.appendChild(div);
                } else if (app.status === "Approved" || app.status === "Sample Collected" || app.status === "Processing") {
                    div.innerHTML += `
                        <select class="border px-2 py-1 rounded-lg status-dropdown" data-id="${app.id}">
                            <option value="Approved" ${app.status === "Approved" ? "selected" : ""}>Approved</option>
                            <option value="Sample Collected" ${app.status === "Sample Collected" ? "selected" : ""}>Sample Collected</option>
                            <option value="Processing" ${app.status === "Processing" ? "selected" : ""}>Processing</option>
                            <option value="Completed">Completed</option>
                        </select>
                    `;
                    approvedList.appendChild(div);
                } else if (app.status === "Completed") {
                    div.innerHTML += `
                        <button class="bg-blue-700 text-white px-2 py-1 rounded-lg upload-btn" data-id="${app.id}">Upload Report</button>
                    `;
                    completedList.appendChild(div);
                }
            });

            document.querySelectorAll(".approve-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    let testId = this.getAttribute("data-id");
                    await fetch("/api/update-tc-status/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ id: testId, status: "Approved" })
                    });
                    fetchAppointments();
                });
            });

            document.querySelectorAll(".reject-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    let testId = this.getAttribute("data-id");
                    let reason = prompt("Enter rejection reason:");
                    await fetch("/api/reject-test-req/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ id: testId, reason: reason })
                    });
                    fetchAppointments();
                });
            });

            document.querySelectorAll(".status-dropdown").forEach(select => {
                select.addEventListener("change", async function () {
                    let testId = this.getAttribute("data-id");
                    let newStatus = this.value;

                    let confirmChange = confirm(`Are you sure you want to change the status to ${newStatus}?`);
                    if (confirmChange) {
                        await fetch("/api/update-tc-status/", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ id: testId, status: newStatus })
                        });
                        fetchAppointments();
                    }
                });
            });

            document.querySelectorAll(".upload-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    let testId = this.getAttribute("data-id");
                    let fileInput = document.createElement("input");
                    fileInput.type = "file";
                    fileInput.accept = ".pdf";
                    fileInput.onchange = async function () {
                        let file = fileInput.files[0];
                        if (!file) return;

                        let formData = new FormData();
                        formData.append("id", testId);
                        formData.append("report_file", file);

                        await fetch("/api/send-test-report/", {
                            method: "POST",
                            body: formData
                        });

                        alert("Report uploaded and email sent!");
                        fetchAppointments();
                    };
                    fileInput.click();
                });
            });
        }

        fetchAppointments();

        // Confirm Logout
  function confirmLogout() {
    if (confirm("Are you sure you want to logout?")) {
        window.location.href = "/logout/";
    }
}
    </script>

</body>
</html>










{% comment %} 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CT Scan Centre</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6 border-b-2 pb-2 border-black">
        <h1 class="text-2xl font-bold text-green-700">CT Scan Centre</h1>
        <a href="#" class="text-green-700 font-semibold">Logout</a>
    </div>

    <!-- Main Grid Container -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Left Section (Status + Completed Tests) -->
        <div class="space-y-6">
            <!-- Reservation Status -->
            <div class="bg-white border border-black p-4 rounded-lg">
                <h2 class="text-lg font-bold text-green-700 mb-4">Reservation Status</h2>
                <div class="space-y-3">
                    <!-- Dummy Data -->
                    <div class="border p-3 rounded-lg">
                        <p class="font-semibold text-green-700">28-11-2024, 13:30</p>
                        <p>Patient Name | P. No: 123456</p>
                        <select class="w-full border p-2 rounded mt-2">
                            <option>Booked</option>
                            <option>Sample Collected</option>
                            <option>Processing Report</option>
                            <option>Completed</option>
                        </select>
                    </div>
                    <div class="border p-3 rounded-lg">
                        <p class="font-semibold text-green-700">28-11-2024, 13:45</p>
                        <p>Patient Name | P. No: 123457</p>
                        <select class="w-full border p-2 rounded mt-2">
                            <option>Booked</option>
                            <option>Sample Collected</option>
                            <option>Processing Report</option>
                            <option>Completed</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Tests Completed (Email Unsent) -->
            <div class="bg-white border border-black p-4 rounded-lg">
                <h2 class="text-lg font-bold text-green-700 mb-4">Tests Completed (Pending Email)</h2>
                <div class="space-y-3">
                    <div class="border p-3 rounded-lg cursor-pointer">
                        <p class="font-semibold text-green-700">28-11-2024, 14:00</p>
                        <p>Patient Name | P. No: 123458</p>
                    </div>
                    <div class="border p-3 rounded-lg cursor-pointer">
                        <p class="font-semibold text-green-700">28-11-2024, 14:15</p>
                        <p>Patient Name | P. No: 123459</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Section (File Upload) -->
        <div class="bg-white border border-black p-4 rounded-lg">
            <h2 class="text-lg font-bold text-green-700 mb-4">Upload Report</h2>
            <div class="mb-4 border p-3 rounded-lg">
                <p class="font-semibold text-green-700">Selected Patient:</p>
                <p>Patient Name | P. No: -</p>
            </div>
            <div class="flex flex-col items-center border border-dashed p-6 rounded-lg">
                <img src="https://cdn-icons-png.flaticon.com/512/337/337946.png" alt="File" class="w-16 h-16">
                <input type="file" id="report-file" class="hidden">
                <label for="report-file" class="cursor-pointer text-green-700 mt-2">Attach File</label>
            </div>
            <button class="bg-green-700 text-white px-4 py-2 rounded-lg shadow-md mt-4 w-full">Send</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            // Fetch appointments dynamically
            async function fetchAppointments() {
                try {
                    let response = await fetch("/api/get-appointments/");
                    let data = await response.json();

                    let appointmentList = document.getElementById("appointment-list");
                    appointmentList.innerHTML = "";
                    data.appointments.forEach(appointment => {
                        let div = document.createElement("div");
                        div.className = "border p-3 rounded-lg";
                        div.innerHTML = `
                            <p class="font-semibold text-green-700">${appointment.time}</p>
                            <p>Patient Name | ID: ${appointment.patient_id}</p>
                            <select class="w-full border p-2 rounded mt-2 status-dropdown" data-id="${appointment.id}">
                                <option ${appointment.status === "Booked" ? "selected" : ""}>Booked</option>
                                <option ${appointment.status === "Sample Collected" ? "selected" : ""}>Sample Collected</option>
                                <option ${appointment.status === "Processing Report" ? "selected" : ""}>Processing Report</option>
                                <option ${appointment.status === "Completed" ? "selected" : ""}>Completed</option>
                            </select>
                        `;
                        appointmentList.appendChild(div);
                    });

                    // Update status on change
                    document.querySelectorAll(".status-dropdown").forEach(select => {
                        select.addEventListener("change", async function () {
                            let appointmentId = this.getAttribute("data-id");
                            let newStatus = this.value;

                            await fetch("/api/update-status/", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ id: appointmentId, status: newStatus })
                            });
                        });
                    });
                } catch (error) {
                    console.error("Error fetching appointments:", error);
                }
            }

            // Fetch completed tests dynamically
            async function fetchCompletedTests() {
                try {
                    let response = await fetch("/api/get-completed-tests/");
                    let data = await response.json();

                    let completedTestsDiv = document.getElementById("completed-tests");
                    completedTestsDiv.innerHTML = "";
                    data.completed_tests.forEach(test => {
                        let div = document.createElement("div");
                        div.className = "border p-3 rounded-lg cursor-pointer completed-test";
                        div.setAttribute("data-id", test.id);
                        div.innerHTML = `
                            <p class="font-semibold text-green-700">${test.time}</p>
                            <p>Patient Name | ID: ${test.patient_id}</p>
                        `;
                        completedTestsDiv.appendChild(div);
                    });

                    // On Click, Load Patient Data
                    document.querySelectorAll(".completed-test").forEach(div => {
                        div.addEventListener("click", function () {
                            let patientInfo = document.getElementById("selected-patient");
                            patientInfo.innerHTML = div.innerHTML;
                        });
                    });
                } catch (error) {
                    console.error("Error fetching completed tests:", error);
                }
            }

            // Send Report
            document.getElementById("send-report").addEventListener("click", async function () {
                let fileInput = document.getElementById("report-file");
                if (fileInput.files.length === 0) {
                    alert("Please select a file.");
                    return;
                }

                let formData = new FormData();
                formData.append("report_file", fileInput.files[0]);

                await fetch("/api/send-report/", {
                    method: "POST",
                    body: formData
                });

                alert("Report sent successfully!");
            });

            // Initial Fetch
            await fetchAppointments();
            await fetchCompletedTests();
        });
    </script>

</body>
</html> {% endcomment %}
