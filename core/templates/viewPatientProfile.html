<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ patients.name}}'s' Profile - syncHealth</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</head>
<body class="bg-gray-50">

    <nav class="bg-white sticky top-0 z-50 shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <a href="/" class="text-xl font-bold text-[#29622E] hover:text-[#35993E]">syncHealth</a>

        <!-- Desktop Navigation -->
        <div class="hidden md:flex space-x-6 items-center">
          <a href="/" class="text-[#29622E] hover:text-[#35993E]">Home</a>
          <a href="/allDepartments" class="text-[#29622E] hover:text-[#35993E]">Departments</a>
          <a href="/allDoctors" class="text-[#29622E] hover:text-[#35993E]">Doctors</a>
          <a href="/healthPackages" class="text-[#29622E] hover:text-[#35993E]">Packages</a>
          <a href="/all-test-centres" class="text-[#29622E] hover:text-[#35993E]">Test Centres</a>
          <a href="/aboutUs" class="text-[#29622E] hover:text-[#35993E]">About Us</a>
        </div>

        <!-- Icons -->
        <div class="hidden md:flex space-x-4 items-center">
          <a href="/chats/" class="text-[#29622E] hover:text-[#35993E]">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h8M8 14h4m5 3l-3-3H6a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2z"/>
            </svg>
          </a>
          <a href="{{profile_redirect}}" class="text-[#29622E] hover:text-[#35993E]">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-4 0-8 2-8 4v2h16v-2c0-2-4-4-8-4z"/>
            </svg>
          </a>
        </div>

        <!-- Mobile Menu Button -->
         
        <div class="md:hidden">
          <button id="menu-toggle" class="text-[#29622E] hover:text-[#35993E]">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Mobile Navigation -->
      <div id="mobile-menu" class="hidden md:hidden space-y-2">
        <a href="/" class="block text-[#29622E] hover:text-[#35993E]">Home</a>
        <a href="/allDepartments" class="block text-[#29622E] hover:text-[#35993E]">Departments</a>
        <a href="/allDoctors" class="block text-[#29622E] hover:text-[#35993E]">Doctors</a>
        <a href="/healthPackages" class="text-[#29622E] hover:text-[#35993E]">Packages</a>
        <a href="/all-test-centres" class="text-[#29622E] hover:text-[#35993E]">Test Centres</a>
        <a href="/aboutUs" class="block text-[#29622E] hover:text-[#35993E]">About Us</a>
        <a href="/chats" class="text-[#29622E] hover:text-[#35993E]">Chats</a>
        <a href="{{profile_redirect}}" class="block text-[#29622E] hover:text-[#35993E]">Profile</a>
      </div>
    </div>
  </nav>


  <section class="p-6">
    <!-- Header -->
    <header class="text-2xl text-[#29622E] font-bold text-center mb-8">
      Patient's Profile | {{patients.name }}
    </header>


    <!-- Main Content -->
    <div class="flex flex-wrap lg:flex-nowrap gap-6">
      <!-- Left Section -->
      <div class="flex flex-col items-center bg-white shadow-md p-6 rounded-lg w-full lg:w-1/3">
        <!-- Profile Image -->
        <img src="/media/{{patient_image}}" alt="Profile Image" class="w-36 h-36 rounded-full mb-4 object-cover bg-gray-200" />
        <p class="text-sm text-[#29622E] mb-4">Patient No: {{patients.patient_no}}</p>
      </div>

      <!-- Right Section -->
      <div class="bg-white shadow-md p-6 rounded-lg w-full lg:w-2/3">
        <p class="mb-4"><span class="font-bold">Name:</span> {{ patients.name}}</p>
        <p class="mb-4"><span class="font-bold">Patient Since:</span> {{ patients.created_at }}</p>
        <p class="mb-4"><span class="font-bold">Age:</span> {{ patients.age}}</p>
        <p class="mb-4"><span class="font-bold">Gender:</span> {{ patients.gender}}</p>
        <p class="mb-4"><span class="font-bold">Address:</span> {{ patients.address}}</p>
        <p class="mb-4"><span class="font-bold">Consultant Doctor(s):</span> {% for doctor in patients.assigned_doctors_data %}
          <a href="mailto:{{doctor.email}}" target="_blank" title="{{doctor.email}}"> {{ doctor.name }}(NMC: {{doctor.nmc}})</a>{% if not forloop.last %}, {% endif %}
      {% endfor %} 
        </p>

        <!-- Placeholder for Health Chart -->
        <div class="w-full h-48 bg-gray-100 hidden rounded-md flex items-center justify-center text-gray-500">
          Graph Placeholder
        </div>

        <!-- Hospital Records -->
        <p class="font-bold mt-6 mb-2">Hospital Records:</p>
        <button onclick="loadPatientHistory('{{ patients.email }}')" class="mt-6 bg-[#29622E] text-white px-4 py-2 rounded-lg shadow hover:bg-[#35993E]">
          View All Detailed Records
        </button>
        <div class="space-y-4 hidden">
          <!-- Each Record -->
          <a href="#" class="block bg-white border border-gray-200 shadow-sm p-4 rounded-lg hover:shadow-md transition">
            <p class="text-[#29622E] font-bold">03-12-2024</p>
            <p class="text-gray-700">Appointment With Dr. Ramesh Dev</p>
          </a>
          <a href="#" class="block bg-white border border-gray-200 shadow-sm p-4 rounded-lg hover:shadow-md transition">
            <p class="text-[#29622E] font-bold">28-11-2024</p>
            <p class="text-gray-700">Blood Test - Blood Test Centre</p>
          </a>
        </div>
      </div>
    </div>
  </section>


  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Replace the Graph Placeholder Div -->
<div id="chart-container" class="bg-white rounded-md p-4 shadow-md">
  <div class="flex justify-between items-center mb-4">
    <h3 class="font-bold text-lg text-[#29622E]">Health Charts - {{patients.name}}</h3>
    <button id="print-chart-btn" class="bg-green-700 text-white px-4 py-1 rounded">Print Chart PDF</button>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <canvas id="bp-chart" height="250"></canvas>
    <canvas id="sugar-chart" height="250"></canvas>
  </div>
</div>



<!-- History Dialog Modal -->
<div id="recordModal" class="fixed inset-0 hidden bg-black bg-opacity-50 items-center justify-center z-50">
  <div class="bg-white rounded-lg w-full max-w-3xl p-6 overflow-y-auto max-h-[90vh] relative">
    <button onclick="toggleModal()" class="absolute top-2 right-4 text-xl">&times;</button>
    <h2 class="text-xl font-bold text-[#29622E] mb-4">Record Details</h2>
    <div id="modal-content" class="space-y-4"></div>
    <button id="print-chart-btn" class="bg-blue-600 text-white px-4 py-2 rounded mt-4 hover:bg-blue-700">
      Print Chart as PDF
    </button>
  </div>
</div>


<div id="record-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-3xl p-6 relative overflow-y-auto max-h-[90vh]">
    <button onclick="toggleModal()" class="absolute top-3 right-3 text-xl">âœ–</button>
    <h2 class="text-xl font-bold text-[#29622E] mb-4">Detailed Record</h2>
    <div id="record-details" class="space-y-4"></div>
    <button onclick="printRecord()" class="bg-[#29622E] text-white px-6 py-2 rounded-lg shadow hover:bg-[#35993E] mt-4">Print Record</button>
  </div>
</div>

  <footer class="bg-[#29622E] mt-20 text-white py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-3 gap-8">
      <!-- Logo Section -->
      <div class="flex items-center">
        <a href="/" class="text-3xl font-bold text-white hover:text-[#35993E]">syncHealth</a>
      </div>
  
      <!-- Contact Section -->
      <div class="space-y-3">
        <h3 class="text-lg font-bold">Contact</h3>
        <p>Email: customer@synchealth.com</p>
        <p>Phone: +977 1234567890</p>
        <a 
          href="#" 
          id="location-link" 
          class="text-white hover:underline"
        >
          Our Location: Kathmandu, Nepal
        </a>
      </div>
  
      <!-- Back to Top and Pharmacy Tracker -->
      <div class="text-right space-y-3">
        <button 
          id="back-to-top" 
          class="flex items-center justify-center bg-[#35993E] text-white p-2 rounded hover:bg-white hover:text-[#29622E]">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
          </svg>
          <span class="ml-2">Back to Top</span>
        </button>
        <a 
          href="#" 
          id="track-pharmacy" 
          class="flex block text-white hover:underline"
        >
          Track Nearby Pharmacies
        </a>
      </div>
    </div>
  
    <!-- Bottom Section -->
    <div class="border-t border-white mt-8 pt-4 text-center">
      <p>&copy; <span id="current-year"></span> syncHealth. All rights reserved.</p>
    </div>
  
    <!-- Popup Box -->
    <div id="popup-box" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center">
      <div class="bg-white p-6 rounded-lg max-w-md w-full">
        <h3 id="popup-title" class="text-lg text-[#35993E] font-bold mb-4"></h3> <!-- Dynamic Title Here -->
        <iframe 
          id="map" 
          src="" 
          width="100%" 
          height="200" 
          frameborder="0" 
          style="border:0;" 
          allowfullscreen="" 
          aria-hidden="false" 
          tabindex="0"
        ></iframe>
        <button 
          id="close-popup" 
          class="mt-4 w-full bg-[#808080] text-white py-2 px-4 rounded hover:bg-[#808099]">
          Close
        </button>
      </div>
    </div>
  </footer>


  <script>

    document.addEventListener("DOMContentLoaded", async () => {
      const patientEmail = "{{patients.email}}";
  
      const [pres, history] = await Promise.all([
        fetch(`/api/prescriptions/${patientEmail}`).then(r => r.json()),
        fetch(`/api/patient-history/${patientEmail}`).then(r => r.json())
      ]);
  
      renderCharts(pres);
    });
  
    function renderCharts(pres) {
      const dates = pres.map(p => p.date);
      const systolic = pres.map(p => parseInt(p.pressure_systolic || 0));
      const diastolic = pres.map(p => parseInt(p.pressure_diastolic || 0));
      const sugar = pres.map(p => parseInt(p.diabetes || 0));
  
      new Chart("bp-chart", {
        type: "line",
        data: {
          labels: dates,
          datasets: [
            { label: "Systolic", data: systolic, borderColor: "#2563EB", fill: false },
            { label: "Diastolic", data: diastolic, borderColor: "#16A34A", fill: false }
          ]
        }
      });
  
      new Chart("sugar-chart", {
        type: "line",
        data: {
          labels: dates,
          datasets: [{ label: "Diabetes", data: sugar, borderColor: "#DC2626", fill: false }]
        }
      });
    }
  
    function showDetails(data) {
      const content = document.getElementById("modal-content");
      content.innerHTML = "";
      Object.entries(data).forEach(([key, val]) => {
        const line = document.createElement("p");
        line.innerHTML = `<span class='font-bold capitalize'>${key.replace("_", " ")}</span>: ${val}`;
        content.appendChild(line);
      });
      toggleModal();
    }
  
    function toggleModal() {
      document.getElementById("recordModal").classList.toggle("hidden");
    }
  
    document.getElementById("print-chart-btn").addEventListener("click", async function () {
      const chartContainer = document.getElementById("chart-container");
  
      if (!window.jspdf || !html2canvas) {
        alert("Required libraries not loaded!");
        return;
      }
  
      const { jsPDF } = window.jspdf;   // âœ… Proper import
      const doc = new jsPDF();
  
      const canvas = await html2canvas(chartContainer);
      const imgData = canvas.toDataURL("image/png");
      doc.addImage(imgData, "PNG", 10, 10, 190, 100);  // (x, y, width, height)
      doc.save("health-chart.pdf");
    });
  
    function downloadChartPDF() {
      import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js').then(jsPDF => {
        const { jsPDF: PDF } = jsPDF;
        const pdf = new jsPDF();
        const canvas1 = document.getElementById("bp-chart");
        const canvas2 = document.getElementById("sugar-chart");
        pdf.text("Blood Pressure", 10, 10);
        pdf.addImage(canvas1.toDataURL(), "PNG", 10, 20, 180, 80);
        pdf.text("Sugar Level", 10, 110);
        pdf.addImage(canvas2.toDataURL(), "PNG", 10, 120, 180, 80);
        pdf.save("HealthCharts.pdf");
      });
    }


    function toggleModal(data = null) {
      const modal = document.getElementById("record-modal");
      modal.classList.toggle("hidden");
      if (data) renderRecordDetails(data);
    }
    
    function renderRecordDetails(data) {
      const container = document.getElementById("record-details");
      container.innerHTML = "";
    
      const append = (title, desc, date, extras = "") => {
        container.innerHTML += `
          <div class="p-4 border rounded-lg bg-gray-50">
            <p class="text-green-700 font-bold">${title}</p>
            <p class="text-sm text-gray-700">${desc}</p>
            <p class="text-xs text-gray-500 mb-2">Date: ${date}</p>
            ${extras}
          </div>`;
      };
    
      data.appointments.forEach(item => {
        let extra = "";
        if (item.prescription) {
          extra = `
            <p><strong>BP:</strong> ${item.prescription.pressure}</p>
            <p><strong>Diabetes:</strong> ${item.prescription.diabetes}</p>
            <p><strong>Medication:</strong> ${item.prescription.medication}</p>
            <p><strong>Notes:</strong> ${item.prescription.notes}</p>`;
        }
        append("Appointment", item.desc, item.date, extra);
      });
    
      data.tests.forEach(item => {
        let extra = item.report_file ? `<a href="${item.report_file}" target="_blank" class="text-blue-600 underline">ðŸ“„ View Report</a>` : "";
        append("Test", item.desc, item.date, extra);
      });
    
      data.packages.forEach(item => {
        append("Package", item.desc, item.date);
      });
    }
    
    function loadPatientHistory(patientEmail) {
      fetch(`/api/patient-records/${patientEmail}/`)
        .then(res => res.json())
        .then(data => toggleModal(data))
        .catch(err => console.error(err));
    }
    
    function printRecord() {
      const content = document.getElementById("record-details").innerHTML;
      const win = window.open("", "_blank");
      win.document.write(`
        <html><head><title>Print Record</title></head><body>${content}</body></html>
      `);
      win.document.close();
      win.focus();
      win.print();
      win.close();
    }


      // Confirm Logout
  function confirmLogout() {
    if (confirm("Are you sure you want to logout?")) {
        window.location.href = "/logout/";
    }
}

// Js for nav and footer

const menuToggle = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');

    menuToggle.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
    });

    document.getElementById('back-to-top').addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    // Show Popup with Map for Location and Pharmacy Tracker
    const popupBox = document.getElementById('popup-box');
    const mapFrame = document.getElementById('map');
    const closePopup = document.getElementById('close-popup');
    const popupTitle = document.getElementById('popup-title'); // Access the title element
    
    document.getElementById('location-link').addEventListener('click', (event) => {
        event.preventDefault();
        popupTitle.textContent = 'Our Location'; // Set the title for location
        mapFrame.src = 'https://www.google.com/maps/embed?pb=YOUR_EMBED_MAP_URL'; // Replace with your actual Google Maps embed link
        popupBox.classList.remove('hidden');
    });
    
    // Dynamic Nearby Pharmacy Tracker
    document.getElementById('track-pharmacy').addEventListener('click', (event) => {
      event.preventDefault();
      popupTitle.textContent = 'Nearby Pharmacy Tracker';

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;

          // Embed Google Maps pharmacy search near user's location
          const searchURL = `https://www.google.com/maps?q=pharmacy&ll=${lat},${lon}&z=15&output=embed`;
          mapFrame.src = searchURL;
          popupBox.classList.remove('hidden');
        }, () => {
          alert("Location permission denied or unavailable.");
        });
      } else {
        alert("Your browser does not support geolocation.");
      }
    });
    // Close Popup
    closePopup.addEventListener('click', () => {
        popupBox.classList.add('hidden');
        mapFrame.src = ''; // Clear the iframe src when popup closes
    });
    
    // Set Current Year
    document.getElementById('current-year').textContent = new Date().getFullYear();


  </script>
</body>
</html>
